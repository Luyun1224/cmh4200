const e="https://script.google.com/macros/s/AKfycbzvl5lYY1LssljDNJJyGuAGsLd3D0sbGSs4QTZxgz2PAZJ38EpsHzEk740LGiQ5AMok/exec";let t=[];new Date;let n=[];const s={"盧英云":"盧英云.png","陳詩芸":"陳詩芸.jpg","楊宜婷":"楊宜婷.png","黃惠津":"黃惠津.png","王嬿茹":"王嬿茹.png","侯昱瑾":"侯昱瑾.png","高瑞穗":"高瑞穗.png","林盟淦":"林盟淦.png","吳曉琪":"吳曉琪.png","許淑怡":"許淑怡.png","林汶秀":"林汶秀.png","林淑雅":"林淑雅.png","廖家德":"廖家德.jpg","劉雯":"劉雯.jpg","楊依玲":"楊依玲.png","李迎真":"李迎真.png"},a={"teaching-center":"教學中心",fdc:"教師培育中心",resident:"住院醫師訓練小組",clerk:"實習醫學生訓練小組",pgy:"PGY訓練組",csc:"臨床技能中心","allied-health":"醫事人員訓練小組","chart-review":"病歷審查小組"};let l="all",r="all",o="all",i="all",d="all",c="all",p="";new Date;const m=e=>({completed:"bg-green-500",active:"bg-purple-500",overdue:"bg-red-500",planning:"bg-yellow-500"}[e]||"bg-gray-500"),g=e=>({completed:"已完成",active:"進行中",overdue:"逾期",planning:"規劃中"}[e]||"未知"),u=e=>e?new Date(e).toLocaleDateString("zh-TW"):"",y=e=>({project:"專案",task:"任務",activity:"活動",meeting:"會議"}[e]||"項目"),f=(e,t)=>{switch(e){case"project":return"text-blue-700";case"task":return"text-green-700";case"activity":return"text-purple-700";case"meeting":return"completed"===t?"text-gray-400":"text-indigo-700";default:return"text-gray-500"}};function h(){const e=document.getElementById("yearFilter"),n=["all",...new Set(t.map(e=>e.startDate?new Date(e.startDate).getFullYear():null).filter(Boolean))].sort();e.innerHTML=n.map(e=>`<option value="${e}">${"all"===e?"全部年份":`${e}年`}</option>`).join(""),e.value=d}function x(){const e=document.getElementById("monthFilter");e.innerHTML=["all",1,2,3,4,5,6,7,8,9,10,11,12].map(e=>`<option value="${e}">${"all"===e?"全部月份":`${e}月`}</option>`).join(""),e.value=c}function b(){let e=t;"all"!==d&&(e=t.filter(e=>e.startDate&&new Date(e.startDate).getFullYear()==d));let h=e;"all"!==c&&(h=e.filter(e=>e.startDate&&new Date(e.startDate).getMonth()+1==c));let x=n;"all"!==l&&(x=n.filter(e=>e.unit===l)),function(e){const t=document.getElementById("groupTabs"),n=[...new Set(e.map(e=>e.group).filter(Boolean))];if(n.length<=1&&"all"!==l)return t.innerHTML="",void(t.style.padding="0");t.style.padding="0.75rem 0";let s="";n.length>0&&(s+=`<button onclick="filterByGroup('all')" id="tab-all" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${"all"===r?"tab-active":"bg-gray-100 hover:bg-gray-200"}">全部組別</button>`),s+=n.map(e=>`<button onclick="filterByGroup('${e}')" id="tab-${e}" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===r?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${a[e]||e}</button>`).join(""),t.innerHTML=s}(x);const b="all"===r?x:x.filter(e=>e.group===r),v=b.map(e=>e.name);let w=h.filter(e=>e.assignees.some(e=>v.includes(e))||e.collaborators&&e.collaborators.some(e=>v.includes(e)));if(p){const e=p.toLowerCase();w=w.filter(t=>t.name.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e))}let $=w;"all"!==i&&($=w.filter(e=>e.assignees.includes(i)||e.collaborators&&e.collaborators.includes(i))),$.sort((e,t)=>new Date(e.startDate)-new Date(t.startDate)),function(){const e=t.filter(e=>"project"===e.type||"task"===e.type),n=t.filter(e=>"activity"===e.type||"meeting"===e.type);document.getElementById("totalTasks").textContent=e.length,document.getElementById("activeTasks").textContent=e.filter(e=>"active"===e.status).length,document.getElementById("overdueTasks").textContent=e.filter(e=>"overdue"===e.status).length,document.getElementById("completedTasks").textContent=t.filter(e=>"completed"===e.status).length,document.getElementById("activityCount").textContent=n.length}(),function(e,t){const n=document.getElementById("teamMembers");if(!e||0===e.length)return void(n.innerHTML='<p class="text-center text-gray-500 py-4">此篩選條件下無成員</p>');const a=new Date,l=a.getMonth()+1,r=a.getDate(),o=`${String(l).padStart(2,"0")}/${String(r).padStart(2,"0")}`;n.innerHTML=e.map(e=>{const n=e.name,a=t.filter(e=>e.assignees.includes(n)||e.collaborators&&e.collaborators.includes(n)),l=a.filter(e=>"overdue"===e.status).length,r=a.filter(e=>"project"===e.type).length,d=a.filter(e=>"task"===e.type).length,c=n===i,p=e.birthday===o,m=p?"birthday-container":"",g=p?'<div class="birthday-hat"></div>':"",u=p?Array.from({length:9}).map((e,t)=>'<div class="confetti"></div>').join(""):"";return`\n        <div onclick="filterByMember('${n}')" class="group relative ${m} flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-300 ${c?"bg-blue-100 shadow-md":"hover:bg-gray-100 hover:shadow-md hover:scale-105"}">\n            \n            <div class="absolute right-full top-1/2 -translate-y-1/2 mr-2 w-48 p-4 bg-white rounded-lg shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-300 z-30">\n                <img src="${s[n]?s[n]:`https://placehold.co/100x100/93c5fd/ffffff?text=${n.charAt(0)}`}" alt="${n}" class="w-24 h-24 rounded-full mx-auto mb-3 border-4 border-blue-300 object-cover shadow-md" onerror="this.src='https://placehold.co/100x100/93c5fd/ffffff?text=${n.charAt(0)}'; this.onerror=null;">\n                <p class="font-bold text-center text-gray-900 text-lg">${n}</p>\n                <a href="#" onclick="viewMemberHistory('${n}', event)" class="block w-full text-center bg-blue-600 text-white font-semibold py-1.5 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm mt-3">檢視個人歷程</a>\n                <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-white"></div>\n            </div>\n\n            ${u}\n            <div class="flex items-center min-w-0">\n                <div class="relative flex-shrink-0">\n                    ${g}\n                    ${s[n]?`<img src="${s[n]}" alt="${n}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.replaceWith(this.parentElement.querySelector('.initial-avatar'))" />`:`<div class="w-10 h-10 bg-sky-500 rounded-full flex items-center justify-center text-white font-semibold initial-avatar">${n.charAt(0)}</div>`}\n                </div>\n                <div class="ml-3 min-w-0">\n                    <p class="font-medium text-gray-900 truncate">${n}</p>\n                    <div class="text-xs text-gray-500 mt-1 flex flex-wrap gap-x-2 gap-y-1">\n                        <span>專案: ${r}</span>\n                        <span>任務: ${d}</span>\n                    </div>\n                </div>\n            </div>\n            <div class="text-right flex-shrink-0 ml-2">\n                ${l>0?`<span class="text-xs font-bold text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center">${l}</span>`:""}\n            </div>\n        </div>`}).join("")}(b,h),function(e){const t=document.getElementById("itemsList");let n=e;"all"!==o&&(n=e.filter(e=>e.status===o)),0!==n.length?t.innerHTML=n.map(e=>{const t=e.checklist||[],n=t.length,s=t.filter(e=>e.completed).length,a=e.progress-(e.lastWeekProgress||0),l=a>0?`<span class="bg-green-100 text-green-800 text-xs font-semibold ml-2 px-2.5 py-0.5 rounded-full">▲ ${a}%</span>`:a<0?`<span class="bg-red-100 text-red-800 text-xs font-semibold ml-2 px-2.5 py-0.5 rounded-full">▼ ${Math.abs(a)}%</span>`:'<span class="text-gray-400 text-xs font-medium ml-2">—</span>',r=n>0?t.map(e=>`\n                <li class="flex items-center ${e.completed?"text-emerald-300":"text-gray-400"}">\n                    <span class="w-5 text-left">${e.completed?"✓":"○"}</span>\n                    <span>${e.name}</span>\n                </li>`).join(""):"<li>無定義的檢查點</li>";return`\n        <div class="bg-white border rounded-xl p-4 flex flex-col h-full shadow-lg hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 ${"overdue"===e.status?"overdue-glow":"border-gray-200"}">\n            <div class="flex-grow">\n                <div class="flex justify-between items-start mb-3">\n                    <div class="flex-1">\n                        <h4 class="font-bold text-lg text-gray-900 mb-1">${e.name} <span class="text-sm font-medium ${f(e.type,e.status)}">(${y(e.type)})</span></h4>\n                        ${e.description?`<p class="text-sm text-gray-500 mt-1 mb-2 whitespace-pre-wrap">${e.description}</p>`:""}\n                        <p class="text-sm text-gray-600">主要負責: ${e.assignees.join(", ")}</p>\n                        ${e.collaborators&&e.collaborators.length>0?`<p class="text-sm text-gray-600">協助: ${e.collaborators.join(", ")}</p>`:""}\n                    </div>\n                    <div class="flex items-center space-x-2 ml-2">\n                        <span class="flex items-center text-sm font-semibold px-2 py-1 rounded-full ${m(e.status)} text-white">${g(e.status)}</span>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="mt-auto border-t border-gray-100 pt-3">\n                <div class="mb-3">\n                    <div class="flex justify-between items-center text-sm mb-1">\n                        <span class="text-gray-600 font-semibold">進度: ${e.progress}%</span>\n                        ${l}\n                    </div>\n                    <div class="w-full bg-gray-200 rounded-full h-2.5">\n                        <div class="progress-bar h-2.5 rounded-full ${m(e.status)}" style="width: ${e.progress}%"></div>\n                    </div>\n                    <div class="relative group">\n                        <p class="text-sm text-gray-600 mt-1 cursor-pointer">檢查點: ${s}/${n}</p>\n                        <div class="absolute bottom-full mb-2 w-64 p-3 bg-slate-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">\n                            <h4 class="font-bold mb-2 border-b border-b-slate-600 pb-1">標準化流程</h4>\n                            <ul class="space-y-1 mt-2">${r}</ul>\n                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="flex justify-between items-center text-xs text-gray-500">\n                    <span>日期: ${u(e.startDate)} - ${e.deadline?u(e.deadline):"無"}</span>\n                    ${"overdue"===e.status?'<span class="text-red-600 font-medium">⚠️ 已逾期</span>':""}\n                </div>\n\n                ${e.helpMessage?`\n                <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-100 flex items-start space-x-3">\n                    <span class="text-xl pt-1">😭</span>\n                    <div>\n                        <p class="font-semibold text-red-800 text-sm">需要協助：</p>\n                        <p class="text-sm text-red-700 whitespace-pre-wrap">${e.helpMessage}</p>\n                    </div>\n                </div>\n                `:""}\n            </div>\n        </div>`}).join(""):t.innerHTML='<div class="text-center text-gray-400 py-8 col-span-full">\n            <i class="fas fa-folder-open fa-3x mb-4"></i>\n            <p class="font-semibold">沒有符合條件的項目</p>\n            <p class="text-sm mt-1">請嘗試調整篩選條件</p>\n        </div>'}($.filter(e=>"project"===e.type||"task"===e.type))}async function v(n="all"){const s=document.getElementById("ai-suggestion-content"),a=["正在準備您的專案數據...","已連線至 AI 引擎...","AI 正在分析風險與機會...","生成個人化決策建議中...","幾乎完成了..."];let l=0;s.innerHTML=`\n        <div class="flex flex-col items-center justify-center p-8">\n            <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>\n            <p id="ai-loading-message" class="mt-4 text-gray-600 font-medium">${a[0]}</p>\n        </div>`;const r=document.getElementById("ai-loading-message"),o=setInterval(()=>{l=(l+1)%a.length,r&&(r.textContent=a[l])},1500);let i=t.filter(e=>["project","task"].includes(e.type)),d="整個團隊";"all"!==n&&(d=n,i=i.filter(e=>e.assignees.includes(n)||e.collaborators&&e.collaborators.includes(n)));const c=i.length,p=i.filter(e=>"overdue"===e.status),m=i.filter(e=>"active"===e.status),g=i.filter(e=>"planning"===e.status),u=i.filter(e=>"completed"===e.status),y=i.filter(e=>e.progress>85&&"active"===e.status),f=m.filter(e=>e.progress-(e.lastWeekProgress||0)<=0&&e.lastWeekProgress>0),h={contents:[{role:"user",parts:[{text:`\n        你是一位頂尖的專案管理與策略顧問，專精於醫療教育領域。請為一位高階經理人，針對 **${d}** 的表現，撰寫一份深入的決策摘要。\n        請務必使用 **繁體中文**，並根據我提供的 **真實數據** 和 **外部情資**，生成一個包含多元洞見的 JSON 物件。\n\n        **內部數據摘要 (Internal Data):**\n        - **分析對象:** ${d}\n        - **負責總項目數:** ${c}\n        - **項目狀態:**\n            - 逾期: ${p.length} 項\n            - 進行中: ${m.length} 項\n            - 規劃中: ${g.length} 項\n            - 已完成: ${u.length} 項\n        - **需立即關注的逾期項目:** ${p.length>0?p.map(e=>`"${e.name}"`).join("; "):"無"}\n        - **進度可能停滯的項目 (一週內無進展):** ${f.length>0?f.map(e=>`"${e.name}"`).join("; "):"無"}\n        - **表現優異的項目 (進度 > 85%):** ${y.length>0?y.map(e=>`"${e.name}"`).join("; "):"無"}\n\n        **外部情資 (External Intelligence):**\n        - **醫療教育趨勢:** 數位轉型和模擬醫學(Simulation-Based Medical Education)是主流，強調使用VR/AR和線上平台提升學習成效。AI輔助診斷與教學日益重要。\n        - **專案管理趨勢:** 敏捷(Agile)與混合式專案管理方法論被廣泛採用，以應對快速變化的需求。利用AI工具進行風險預測與資源分配是前緣實踐。\n\n        請基於以上內外部資訊，填充以下 JSON 結構。請提供具體、可執行的分析與建議，而不僅僅是重複數據。\n    `}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{healthOverview:{type:"OBJECT",description:"對整體專案組合的健康度進行快速總結。",properties:{summary:{type:"STRING",description:"用1-2句話總結目前專案組合的整體健康度，點出最關鍵的挑戰與優勢。"},ragAnalysis:{type:"ARRAY",description:"RAG燈號分析列表，每個燈號一個物件。",items:{type:"OBJECT",properties:{status:{type:"STRING",description:"燈號狀態 (例如: 紅燈 (逾期), 黃燈 (進行中), 藍燈 (規劃中), 綠燈 (已完成))"},count:{type:"NUMBER",description:"該狀態的項目數量"},example:{type:"STRING",description:"如果是紅燈，提供一個最關鍵的逾期項目名稱作為範例。其他狀態則為空字串。"}}}}}},opportunities:{type:"ARRAY",description:"根據數據識別出的亮點與機會。",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"機會點的次標題，例如 '高績效專案' 或 '潛力領域'。"},points:{type:"ARRAY",items:{type:"STRING"},description:"列出具體的項目或觀察，並說明為何這是個機會點。"}}}},riskAssessment:{type:"ARRAY",description:"需要管理者關注的風險。",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"風險次標題，例如 '逾期項目衝擊' 或 '進度停滯警示'。"},points:{type:"ARRAY",items:{type:"STRING"},description:"列出具體的風險項目，並簡要說明其潛在影響。"}}}},recommendations:{type:"ARRAY",description:"基於上述分析，提供給管理者的具體、可操作的建議。",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"建議的次標題，例如 '優先處理事項' 或 '策略性投入'。"},points:{type:"ARRAY",items:{type:"STRING"},description:"提出具體的行動步驟，例如召開特定會議、調整資源、引入新工具或方法等。"}}}},industryInsights:{type:"ARRAY",description:"結合外部情資，提供與當前專案相關的宏觀策略洞見。",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"洞察的次標題，例如 '連結數位轉型趨勢' 或 '導入敏捷管理思維'。"},points:{type:"ARRAY",items:{type:"STRING"},description:"說明如何將外部趨勢應用於當前專案或未來規劃中。"}}}}}}}};try{const t=await fetch(e,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"getAiSuggestionProxy",payload:h})}),n=await t.json();if(n.error)throw new Error(n.error.message||"後端回傳未知錯誤");if(!(n.candidates&&n.candidates.length>0&&n.candidates[0].content.parts[0].text))throw new Error("AI 未能提供有效的建議。回應為空或格式不符。");{const e=n.candidates[0].content.parts[0].text,t=JSON.parse(e);s.innerHTML=function(e){const{healthOverview:t={},opportunities:n=[],riskAssessment:s=[],recommendations:a=[],industryInsights:l=[]}=e,r=(e,t,n,s,a)=>a?"":`\n            <div class="mb-6">\n                <h3 class="text-lg font-bold ${t} flex items-center mb-3"><i class="fas ${n} fa-fw mr-3"></i>${e}</h3>\n                <div class="pl-5 space-y-4">${s}</div>\n            </div>\n        `,o=e=>{if(!Array.isArray(e)||0===e.length)return'<p class="text-sm text-gray-500">無具體項目。</p>';let t='<ul class="list-none space-y-2">';return t+=e.map(e=>`\n            <li class="flex items-start">\n                <span class="mr-3 text-gray-500 mt-1.5 text-xs">●</span>\n                <span class="text-gray-800 flex-1 text-sm">${e}</span>\n            </li>\n        `).join(""),t+="</ul>",t},i=(e,t,n)=>Array.isArray(e)&&0!==e.length?e.map(e=>{const s=n[e.title]||"fa-lightbulb";return`<div class="space-y-2"><strong class="font-bold ${t} flex items-center text-sm"><i class="fas ${s} w-5 text-center mr-2"></i>${e.title}</strong><div class="pl-5">${o(e.points)}</div></div>`}).join('<hr class="my-4 border-gray-200">'):'<p class="pl-5 text-sm text-gray-500">無</p>',d=`\n        <p class="text-gray-700 mb-4">${t.summary||"無法生成總結。"}</p>\n        <ul class="space-y-2 pl-4">\n        ${(t.ragAnalysis||[]).map(e=>{let t="text-gray-600",n="fa-info-circle";e.status.includes("紅")||e.status.includes("逾期")?(t="text-red-600",n="fa-exclamation-triangle"):e.status.includes("黃")||e.status.includes("進行中")?(t="text-yellow-600",n="fa-tasks"):e.status.includes("藍")||e.status.includes("規劃中")?(t="text-blue-600",n="fa-map"):(e.status.includes("綠")||e.status.includes("已完成"))&&(t="text-green-600",n="fa-check-circle");const s=e.example?` ("${e.example}")`:"";return`<li class="flex items-start">\n                        <i class="fas ${n} ${t} w-5 mt-1 mr-3"></i>\n                        <span class="font-semibold text-gray-800">${e.status}: ${e.count} 項${s}</span>\n                    </li>`}).join("")}\n        </ul>\n    `,c=i(n,"text-teal-600",{"高績效專案":"fa-award","潛力領域":"fa-search-plus"}),p=i(s,"text-red-800",{"逾期項目衝擊":"fa-fire-alt","進度停滯警示":"fa-ghost"}),m=i(a,"text-blue-800",{"優先處理事項":"fa-star","策略性投入":"fa-chess-knight"}),g=i(l,"text-indigo-800",{"連結數位轉型趨勢":"fa-laptop-medical","導入敏捷管理思維":"fa-running"});let u='<div class="space-y-6">';return u+=r("專案組合健康度速覽 (RAG 分析)","text-gray-700","fa-chart-pie",d,!t.summary),u+=r("機會點與亮點","text-teal-600","fa-sun",c,0===n.length),u+=r("風險評估與預警","text-red-600","fa-shield-alt",p,0===s.length),u+=r("具體行動建議","text-blue-600","fa-user-tie",m,0===a.length),u+=r("外部趨勢與策略洞察","text-indigo-600","fa-globe-asia",g,0===l.length),u+="</div>",u}(t)}}catch(e){console.error("AI Suggestion Error:",e),s.innerHTML=`\n            <div class="p-4 bg-red-100 text-red-700 rounded-lg">\n                <p class="font-bold">無法獲取 AI 建議</p>\n                <p>${e.message}</p>\n            </div>`}finally{clearInterval(o)}}function w(){document.getElementById("weeklySummaryModal");const e=document.getElementById("weekly-summary-content");e.innerHTML='<div class="p-8 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-2xl text-green-500 mr-3"></i> 正在生成本週回顧...</div>';const n=new Date,s=new Date;s.setDate(n.getDate()-7);const a=new Date;a.setDate(n.getDate()+7);const l=t.filter(e=>["project","task"].includes(e.type)),r=l.filter(e=>{if("completed"!==e.status)return!1;const t=e.deadline?new Date(e.deadline):null;if(!t)return!1;const a=t>=s&&t<=n,l=100===(e.lastWeekProgress||0);return a&&!l}),o=l.filter(e=>"completed"!==e.status&&e.progress>(e.lastWeekProgress||0)),i=l.filter(e=>new Date(e.startDate)>=s&&new Date(e.startDate)<=n),d=l.filter(e=>"active"===e.status&&e.progress===(e.lastWeekProgress||0)),c=l.filter(e=>e.deadline&&new Date(e.deadline)>n&&new Date(e.deadline)<=a&&"completed"!==e.status),p=l.filter(e=>e.helpMessage&&""!==e.helpMessage.trim());let m="";const g=(e,t,n,s,a)=>{let l=`<div class="mb-4">\n            <h3 class="text-lg font-bold ${n} flex items-center mb-2"><i class="fas ${t} fa-fw mr-2"></i>${e} (${s.length})</h3>`;return s.length>0?(l+='<ul class="space-y-2 pl-5">',l+=s.map(t=>`<li class="text-sm text-gray-800 p-2 bg-gray-50 rounded-md border-l-4 ${n.replace("text-","border-")}">\n                    <strong>${t.name}</strong> - <span class="text-gray-500">負責人: ${t.assignees.join(", ")}</span>\n                    ${e.includes("進度")?`<span class="font-medium text-green-600"> (+${t.progress-(t.lastWeekProgress||0)}%)</span>`:""}\n                    ${e.includes("到期")?`<span class="font-medium text-yellow-800"> (到期日: ${u(t.deadline)})</span>`:""}\n                    ${e.includes("協助")?`<p class="text-sm text-red-700 mt-1 pl-2 border-l-2 border-red-200 bg-red-50 py-1"><em>"${t.helpMessage}"</em></p>`:""}\n                </li>`).join(""),l+="</ul>"):l+=`<p class="pl-5 text-sm text-gray-500">${a}</p>`,l+="</div>",l};m+=g("本週完成項目","fa-check-circle","text-green-600",r,"本週沒有完成的項目。"),m+=g("本週進度更新","fa-rocket","text-blue-600",o,"本週沒有項目取得進展。"),m+=g("本週新增項目","fa-lightbulb","text-purple-600",i,"本週沒有新增項目。"),m+=g("下週到期項目","fa-clock","text-yellow-600",c,"下週沒有即將到期的項目。"),m+=g("進度停滯項目","fa-pause-circle","text-orange-500",d,"所有項目皆有進展，太棒了！"),m+=g("需要協助項目","fa-hands-helping","text-red-600",p,"沒有項目發出求救信號。"),e.innerHTML=m}function $(e,t,n,s){const a=document.getElementById(e),l=t?document.getElementById(t):null,r=document.getElementById(n),o=()=>a.classList.add("hidden");l&&l.addEventListener("click",()=>{a.classList.remove("hidden"),s&&s()}),r.addEventListener("click",o),a.addEventListener("click",e=>{e.target===a&&o()})}function E(){const e=document.getElementById("openChatBot"),n=document.getElementById("closeChatBot"),s=document.getElementById("chatBotContainer"),a=document.getElementById("chatBotMessages");e.addEventListener("click",()=>{s.classList.remove("hidden"),a.innerHTML='<div class="p-4"><i class="fas fa-spinner fa-spin text-indigo-500"></i> 正在產生報告...</div>',setTimeout(()=>{a.innerHTML=function(){const e=new Date,n=e.toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}),s=e.getMonth()+1,a=e.getFullYear(),l=t.filter(e=>{const t=new Date(e.startDate);return t.getFullYear()===a&&t.getMonth()+1===s}),r=l.filter(e=>"completed"===e.status&&"project"===e.type).length,o=l.filter(e=>"completed"===e.status&&"task"===e.type).length,i=t.filter(e=>"active"===e.status&&"project"===e.type).length,d=t.filter(e=>"active"===e.status&&"task"===e.type).length,c=t.filter(e=>"overdue"===e.status),p=t.filter(t=>"completed"===t.status&&new Date(t.deadline)<=e&&"project"===t.type).sort((e,t)=>new Date(t.deadline)-new Date(e.deadline)),m=p.length>0?p[0]:null,g=l.filter(e=>"completed"===e.status&&"task"===e.type).map(e=>e.name).slice(0,2),y=new Date(e);y.setDate(e.getDate()+7);const f=t.filter(t=>{const n=new Date(t.startDate);return"completed"!==t.status&&n>e&&n<=y}).map(e=>`[${u(e.startDate)}]: ${e.name}`);let h='<div class="p-2 space-y-4 text-gray-800">';if(h+=`<p>您好！這是截至 <strong>${n}</strong> 的本月重點彙報。</p>`,h+='<div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">\n        <h3 class="font-bold text-yellow-800">⭐ 本月亮點 (Highlights)</h3>\n        <ul class="list-none text-sm text-yellow-700 mt-2 space-y-1">',h+=`<li><span class="font-semibold">🎉 專案達標：</span> 本月共完成 <strong>${r}</strong> 項專案、<strong>${o}</strong> 項任務！</li>`,h+=m?`<li><span class="font-semibold">🚀 指標專案上線：</span> 「${m.name}」已於 ${u(m.deadline)} 順利完成。</li>`:'<li><span class="font-semibold">🚀 指標專案上線：</span> 本月尚無指標專案完成。</li>',h+="</ul></div>",h+=`<div class="p-3 bg-blue-50 rounded-lg border border-blue-200">\n        <h3 class="font-bold text-blue-800">⚙️ 專案進度 (Project Progress)</h3>\n        <ul class="list-none text-sm text-blue-700 mt-2 space-y-1">\n            <li><strong>進行中專案：</strong> ${i} 項</li>\n            <li><strong>進行中任務：</strong> ${d} 項</li>\n            <li><strong>本月完成里程碑：</strong> ${g.length>0?g.join(", "):"無"}</li>\n        </ul></div>`,c.length>0){const e=c[0];h+=`<div class="p-3 bg-red-50 rounded-lg border border-red-200">\n            <h3 class="font-bold text-red-800">⚠️ 風險提示</h3>\n            <p class="text-sm text-red-700 mt-1">「${e.name}」目前處於逾期狀態，需負責人 <strong>${e.assignees.join(", ")}</strong> 重點關注。</p>\n            </div>`}return h+='<div class="p-3 bg-green-50 rounded-lg border border-green-200">\n        <h3 class="font-bold text-green-800">🗓️ 下週重點預告 (Coming Up)</h3>',f.length>0?h+=`<ul class="list-none text-sm text-green-700 mt-2 space-y-1">\n            ${f.map(e=>`<li>${e}</li>`).join("")}\n            </ul>`:h+='<p class="text-sm text-green-700 mt-1">下週尚無排定重點事項。</p>',h+="</div>",h+='<p class="text-xs text-gray-500 text-center pt-2">希望這份彙報對您有幫助！</p>',h+="</div>",h}()},100)}),n.addEventListener("click",()=>{s.classList.add("hidden")})}async function B(){const s=document.getElementById("loadingOverlay"),a=document.getElementById("errorDisplay");s.classList.remove("hidden");try{const s=await fetch(e,{method:"POST",mode:"cors",body:JSON.stringify({action:"getDashboardData"}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!s.ok)throw new Error(`Network response was not ok: ${s.statusText}`);const a=await s.json();if("success"!==a.status)throw new Error(a.message);const r=a.data.staffData||[];n=r.map(e=>({id:e.employeeId,name:e.name,group:e.group,birthday:e.birthday,unit:e.unit}));const i=a.data.activities||[],d=new Date;d.setHours(0,0,0,0),t=i.map(e=>{const t=parseInt(e.progress,10)||0,n=e.deadline?new Date(e.deadline):null;let s=e.status||"planning";return t>=100?s="completed":"completed"!==s&&n&&n<d&&(s="overdue"),{...e,progress:t,status:s,lastWeekProgress:e.lastWeekProgress?parseInt(e.lastWeekProgress,10):0,helpMessage:e.helpMessage||"",checklist:Array.isArray(e.checklist)?e.checklist:[]}});const c=new URLSearchParams(window.location.search).get("status");if(c&&(o=c),function(){const e=document.getElementById("unitTabs");if(!n||0===n.length)return;const t=["all",...new Set(n.map(e=>e.unit).filter(Boolean))];e.innerHTML=t.map(e=>`<button onclick="filterByUnit('${e}')" id="tab-unit-${e}" class="unit-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===l?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${"all"===e?"全部單位":e}</button>`).join("")}(),h(),x(),b(),c){const e=document.querySelector(`.filter-btn[onclick*="${c}"]`);e&&function(e,t){o=e;const n={all:["bg-blue-100","text-blue-700"],planning:["bg-yellow-100","text-yellow-700"],active:["bg-purple-100","text-purple-700"],completed:["bg-green-100","text-green-700"],overdue:["bg-red-100","text-red-700"]};document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active",...Object.values(n).flat()),e.classList.add("bg-gray-100","text-gray-700")}),t.target.classList.add("active",...n[e]),t.target.classList.remove("bg-gray-100","text-gray-700"),b()}(c,{target:e})}document.getElementById("openChatBot").classList.remove("hidden")}catch(e){console.error("Initialization failed:",e),document.getElementById("errorMessage").textContent=`無法從伺服器獲取專案數據。請檢查您的網路連線或稍後再試。(${e.message})`,a.classList.remove("hidden")}finally{s.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",async function(){!function(){const t=document.getElementById("loginBtn"),n=document.getElementById("loginModal"),s=document.getElementById("closeModalBtn"),a=document.getElementById("loginForm"),l=document.getElementById("login-message"),r=document.getElementById("loginSubmitBtn"),o=r.querySelector(".btn-text"),i=r.querySelector(".btn-spinner"),d=document.getElementById("togglePassword"),c=document.getElementById("password"),p=document.getElementById("openChangePasswordModalBtn");d.addEventListener("click",function(){const e="password"===c.getAttribute("type")?"text":"password";c.setAttribute("type",e),this.querySelector("i").classList.toggle("fa-eye"),this.querySelector("i").classList.toggle("fa-eye-slash")}),p.addEventListener("click",()=>{n.classList.add("hidden"),document.getElementById("changePasswordModal").classList.remove("hidden")}),t.addEventListener("click",()=>{l.textContent="",a.reset(),n.classList.remove("hidden")}),s.addEventListener("click",()=>n.classList.add("hidden")),n.addEventListener("click",e=>{e.target===n&&n.classList.add("hidden")}),a.addEventListener("submit",async t=>{t.preventDefault();const n=t.target.username.value,s=t.target.password.value;l.textContent="",o.textContent="登入中...",i.classList.remove("hidden"),r.disabled=!0;try{const t=await fetch(e,{method:"POST",mode:"cors",body:JSON.stringify({action:"login",username:n,password:s}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!t.ok)throw new Error(`網路回應錯誤: ${t.status} ${t.statusText}`);const a=await t.json();if("success"!==a.status)throw new Error(a.message||"帳號或密碼錯誤。");{const e=a.data;l.textContent="登入成功！即將跳轉...",l.className="text-center mb-4 font-medium text-green-500",setTimeout(()=>{window.location.href=`https://luyun1224.github.io/cmh4200/project-admin.html?user=${encodeURIComponent(e.name)}&id=${e.employeeId}`},1500)}}catch(e){console.error("Login Error Details:",e),l.textContent=e.message,l.className="text-center mb-4 font-medium text-red-500"}finally{o.textContent="登入",i.classList.add("hidden"),r.disabled=!1}})}(),function(){const t=document.getElementById("changePasswordModal"),n=document.getElementById("changePasswordForm"),s=document.getElementById("change-password-message"),a=document.getElementById("changePasswordSubmitBtn");document.getElementById("closeChangePasswordModalBtn").addEventListener("click",()=>{t.classList.add("hidden"),document.getElementById("loginModal").classList.remove("hidden")}),n.addEventListener("submit",async t=>{t.preventDefault();const l=n.elements.employeeId.value,r=n.elements.oldPassword.value,o=n.elements.newPassword.value;s.textContent="",a.disabled=!0,a.querySelector(".btn-text").textContent="處理中...",a.querySelector(".btn-spinner").classList.remove("hidden");try{const t=await fetch(e,{method:"POST",mode:"cors",body:JSON.stringify({action:"updatePassword",employeeId:l,oldPassword:r,newPassword:o}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!t.ok)throw new Error("網路回應錯誤");const a=await t.json();if("success"!==a.status)throw new Error(a.message||"更新失敗");s.textContent="密碼更新成功！",s.className="text-center mb-4 font-medium text-green-500",n.reset()}catch(e){s.textContent=e.message,s.className="text-center mb-4 font-medium text-red-500"}finally{a.disabled=!1,a.querySelector(".btn-text").textContent="確認更換",a.querySelector(".btn-spinner").classList.add("hidden")}})}(),function(){const e=document.getElementById("aiModal"),t=document.getElementById("aiBtn"),s=document.getElementById("closeAiModalBtn"),a=document.getElementById("aiMemberFilter"),l=()=>e.classList.add("hidden");t.addEventListener("click",()=>{a.innerHTML='<option value="all">總體分析</option>',n.forEach(e=>{a.innerHTML+=`<option value="${e.name}">${e.name}</option>`}),a.value="all",e.classList.remove("hidden"),v("all")}),s.addEventListener("click",l),e.addEventListener("click",t=>{t.target===e&&l()}),a.addEventListener("change",e=>{v(e.target.value)})}(),$("activityModal",null,"closeActivityModalBtn"),$("weeklySummaryModal","weeklySummaryBtn","closeWeeklySummaryBtn",w),function(){const e=document.getElementById("scrollToTopBtn");window.onscroll=()=>{document.body.scrollTop>20||document.documentElement.scrollTop>20?e.classList.remove("hidden"):e.classList.add("hidden")},e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})}(),$("itemListModal",null,"closeItemListModalBtn"),E(),await B()});
