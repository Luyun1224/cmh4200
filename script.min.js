const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzvl5lYY1LssljDNJJyGuAGsLd3D0sbGSs4QTZxgz2PAZJ38EpsHzEk740LGiQ5AMok/exec";let allActivities=[];const currentDate=new Date;let staffData=[];const localProfileImages={"ç›§è‹±äº‘":"ç›§è‹±äº‘.png","é™³è©©èŠ¸":"é™³è©©èŠ¸.jpg","æ¥Šå®œå©·":"æ¥Šå®œå©·.png","é»ƒæƒ æ´¥":"é»ƒæƒ æ´¥.png","ç‹å¬¿èŒ¹":"ç‹å¬¿èŒ¹.png","ä¾¯æ˜±ç‘¾":"ä¾¯æ˜±ç‘¾.png","é«˜ç‘ç©—":"é«˜ç‘ç©—.png","æ—ç›Ÿæ·¦":"æ—ç›Ÿæ·¦.png","å³æ›‰çª":"å³æ›‰çª.png","è¨±æ·‘æ€¡":"è¨±æ·‘æ€¡.png","æ—æ±¶ç§€":"æ—æ±¶ç§€.png","æ—æ·‘é›…":"æ—æ·‘é›….png","å»–å®¶å¾·":"å»–å®¶å¾·.jpg","åŠ‰é›¯":"åŠ‰é›¯.jpg","æ¥Šä¾ç²":"æ¥Šä¾ç².png","æè¿çœŸ":"æè¿çœŸ.png"},groupData={"teaching-center":"æ•™å­¸ä¸­å¿ƒ",fdc:"æ•™å¸«åŸ¹è‚²ä¸­å¿ƒ",resident:"ä½é™¢é†«å¸«è¨“ç·´å°çµ„",clerk:"å¯¦ç¿’é†«å­¸ç”Ÿè¨“ç·´å°çµ„",pgy:"PGYè¨“ç·´çµ„",csc:"è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒ","allied-health":"é†«äº‹äººå“¡è¨“ç·´å°çµ„","chart-review":"ç—…æ­·å¯©æŸ¥å°çµ„"};let currentUnitFilter="all",currentGroupFilter="all",currentStatusFilter="all",currentMemberFilter="all",currentYearFilter="all",currentMonthFilter="all",currentSearchTerm="",calendarDate=new Date;const getStatusColor=e=>({completed:"bg-green-500",active:"bg-purple-500",overdue:"bg-red-500",planning:"bg-yellow-500"})[e]||"bg-gray-500",getStatusText=e=>({completed:"å·²å®Œæˆ",active:"é€²è¡Œä¸­",overdue:"é€¾æœŸ",planning:"è¦åŠƒä¸­"})[e]||"æœªçŸ¥",formatDate=e=>e?new Date(e).toLocaleDateString("zh-TW"):"",getTypeText=e=>({project:"å°ˆæ¡ˆ",task:"ä»»å‹™",activity:"æ´»å‹•",meeting:"æœƒè­°"})[e]||"é …ç›®",getTypeStyle=(e,t)=>{switch(e){case"project":return"text-blue-700";case"task":return"text-green-700";case"activity":return"text-purple-700";case"meeting":return"completed"===t?"text-gray-400":"text-indigo-700";default:return"text-gray-500"}};function renderUnitTabs(){const e=document.getElementById("unitTabs");if(!staffData||0===staffData.length)return;const t=["all",...new Set(staffData.map(e=>e.unit).filter(Boolean))];e.innerHTML=t.map(e=>{const t="all"===e?"å…¨éƒ¨å–®ä½":e;return`<button onclick="filterByUnit('${e}')" id="tab-unit-${e}" class="unit-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===currentUnitFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${t}</button>`}).join("")}function renderGroupTabs(e){const t=document.getElementById("groupTabs"),n=[...new Set(e.map(e=>e.group).filter(Boolean))];if(n.length<=1&&"all"!==currentUnitFilter)return t.innerHTML="",void(t.style.padding="0");t.style.padding="0.75rem 0";let s="";n.length>0&&(s+=`<button onclick="filterByGroup('all')" id="tab-all" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${"all"===currentGroupFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">å…¨éƒ¨çµ„åˆ¥</button>`),s+=n.map(e=>{const t=groupData[e]||e;return`<button onclick="filterByGroup('${e}')" id="tab-${e}" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===currentGroupFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${t}</button>`}).join(""),t.innerHTML=s}function renderYearFilter(){const e=document.getElementById("yearFilter"),t=["all",...new Set(allActivities.map(e=>e.startDate?new Date(e.startDate).getFullYear():null).filter(Boolean))].sort();e.innerHTML=t.map(e=>`<option value="${e}">${"all"===e?"å…¨éƒ¨å¹´ä»½":`${e}å¹´`}</option>`).join(""),e.value=currentYearFilter}function renderMonthFilter(){const e=document.getElementById("monthFilter"),t=["all",1,2,3,4,5,6,7,8,9,10,11,12];e.innerHTML=t.map(e=>`<option value="${e}">${"all"===e?"å…¨éƒ¨æœˆä»½":`${e}æœˆ`}</option>`).join(""),e.value=currentMonthFilter}function renderItems(e){const t=document.getElementById("itemsList");let n=e;"all"!==currentStatusFilter&&(n=e.filter(e=>e.status===currentStatusFilter)),0!==n.length?t.innerHTML=n.map(e=>{const t=e.checklist||[],n=t.length,s=t.filter(e=>e.completed).length,a=e.progress-(e.lastWeekProgress||0),r=a>0?`<span class="bg-green-100 text-green-800 text-xs font-semibold ml-2 px-2.5 py-0.5 rounded-full">â–² ${a}%</span>`:a<0?`<span class="bg-red-100 text-red-800 text-xs font-semibold ml-2 px-2.5 py-0.5 rounded-full">â–¼ ${Math.abs(a)}%</span>`:'<span class="text-gray-400 text-xs font-medium ml-2">â€”</span>',l=n>0?t.map(e=>`\n                <li class="flex items-center ${e.completed?"text-emerald-300":"text-gray-400"}">\n                    <span class="w-5 text-left">${e.completed?"âœ“":"â—‹"}</span>\n                    <span>${e.name}</span>\n                </li>`).join(""):"<li>ç„¡å®šç¾©çš„æª¢æŸ¥é»</li>";return`\n        <div class="bg-white border rounded-xl p-4 flex flex-col h-full shadow-lg hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 ${"overdue"===e.status?"overdue-glow":"border-gray-200"}">\n            <div class="flex-grow">\n                <div class="flex justify-between items-start mb-3">\n                    <div class="flex-1">\n                        <h4 class="font-bold text-lg text-gray-900 mb-1">${e.name} <span class="text-sm font-medium ${getTypeStyle(e.type,e.status)}">(${getTypeText(e.type)})</span></h4>\n                        ${e.description?`<p class="text-sm text-gray-500 mt-1 mb-2 whitespace-pre-wrap">${e.description}</p>`:""}\n                        <p class="text-sm text-gray-600">ä¸»è¦è² è²¬: ${e.assignees.join(", ")}</p>\n                        ${e.collaborators&&e.collaborators.length>0?`<p class="text-sm text-gray-600">å”åŠ©: ${e.collaborators.join(", ")}</p>`:""}\n                    </div>\n                    <div class="flex items-center space-x-2 ml-2">\n                        <span class="flex items-center text-sm font-semibold px-2 py-1 rounded-full ${getStatusColor(e.status)} text-white">${getStatusText(e.status)}</span>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="mt-auto border-t border-gray-100 pt-3">\n                <div class="mb-3">\n                    <div class="flex justify-between items-center text-sm mb-1">\n                        <span class="text-gray-600 font-semibold">é€²åº¦: ${e.progress}%</span>\n                        ${r}\n                    </div>\n                    <div class="w-full bg-gray-200 rounded-full h-2.5">\n                        <div class="progress-bar h-2.5 rounded-full ${getStatusColor(e.status)}" style="width: ${e.progress}%"></div>\n                    </div>\n                    <div class="relative group">\n                        <p class="text-sm text-gray-600 mt-1 cursor-pointer">æª¢æŸ¥é»: ${s}/${n}</p>\n                        <div class="absolute bottom-full mb-2 w-64 p-3 bg-slate-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">\n                            <h4 class="font-bold mb-2 border-b border-b-slate-600 pb-1">æ¨™æº–åŒ–æµç¨‹</h4>\n                            <ul class="space-y-1 mt-2">${l}</ul>\n                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="flex justify-between items-center text-xs text-gray-500">\n                    <span>æ—¥æœŸ: ${formatDate(e.startDate)} - ${e.deadline?formatDate(e.deadline):"ç„¡"}</span>\n                    ${"overdue"===e.status?'<span class="text-red-600 font-medium">âš ï¸ å·²é€¾æœŸ</span>':""}\n                </div>\n\n                ${e.helpMessage?`\n                <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-100 flex items-start space-x-3">\n                    <span class="text-xl pt-1">ğŸ˜­</span>\n                    <div>\n                        <p class="font-semibold text-red-800 text-sm">éœ€è¦å”åŠ©ï¼š</p>\n                        <p class="text-sm text-red-700 whitespace-pre-wrap">${e.helpMessage}</p>\n                    </div>\n                </div>\n                `:""}\n            </div>\n        </div>`}).join(""):t.innerHTML='<div class="text-center text-gray-400 py-8 col-span-full">\n            <i class="fas fa-folder-open fa-3x mb-4"></i>\n            <p class="font-semibold">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®</p>\n            <p class="text-sm mt-1">è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p>\n        </div>'}function renderTeamMembers(e,t){const n=document.getElementById("teamMembers");if(!e||0===e.length)return void(n.innerHTML='<p class="text-center text-gray-500 py-4">æ­¤ç¯©é¸æ¢ä»¶ä¸‹ç„¡æˆå“¡</p>');const s=new Date,a=s.getMonth()+1,r=s.getDate(),l=`${(a+"").padStart(2,"0")}/${(r+"").padStart(2,"0")}`;n.innerHTML=e.map(e=>{const n=e.name,s=t.filter(e=>e.assignees.includes(n)||e.collaborators&&e.collaborators.includes(n)),a=s.filter(e=>"overdue"===e.status).length,r=s.filter(e=>"project"===e.type).length,i=s.filter(e=>"task"===e.type).length,o=n===currentMemberFilter,c=e.birthday===l,d=c?"birthday-container":"",u=c?'<div class="birthday-hat"></div>':"",p=c?Array.from({length:9}).map((e,t)=>'<div class="confetti"></div>').join(""):"";return`\n        <div onclick="filterByMember('${n}')" class="group relative ${d} flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-300 ${o?"bg-blue-100 shadow-md":"hover:bg-gray-100 hover:shadow-md hover:scale-105"}">\n            \n            <div class="absolute right-full top-1/2 -translate-y-1/2 mr-2 w-48 p-4 bg-white rounded-lg shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-300 z-30">\n                <img src="${localProfileImages[n]?localProfileImages[n]:`https://placehold.co/100x100/93c5fd/ffffff?text=${n.charAt(0)}`}" alt="${n}" class="w-24 h-24 rounded-full mx-auto mb-3 border-4 border-blue-300 object-cover shadow-md" onerror="this.src='https://placehold.co/100x100/93c5fd/ffffff?text=${n.charAt(0)}'; this.onerror=null;">\n                <p class="font-bold text-center text-gray-900 text-lg">${n}</p>\n                <a href="#" onclick="viewMemberHistory('${n}', event)" class="block w-full text-center bg-blue-600 text-white font-semibold py-1.5 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm mt-3">æª¢è¦–å€‹äººæ­·ç¨‹</a>\n                <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-white"></div>\n            </div>\n\n            ${p}\n            <div class="flex items-center min-w-0">\n                <div class="relative flex-shrink-0">\n                    ${u}\n                    ${localProfileImages[n]?`<img src="${localProfileImages[n]}" alt="${n}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.replaceWith(this.parentElement.querySelector('.initial-avatar'))" />`:`<div class="w-10 h-10 bg-sky-500 rounded-full flex items-center justify-center text-white font-semibold initial-avatar">${n.charAt(0)}</div>`}\n                </div>\n                <div class="ml-3 min-w-0">\n                    <p class="font-medium text-gray-900 truncate">${n}</p>\n                    <div class="text-xs text-gray-500 mt-1 flex flex-wrap gap-x-2 gap-y-1">\n                        <span>å°ˆæ¡ˆ: ${r}</span>\n                        <span>ä»»å‹™: ${i}</span>\n                    </div>\n                </div>\n            </div>\n            <div class="text-right flex-shrink-0 ml-2">\n                ${a>0?`<span class="text-xs font-bold text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center">${a}</span>`:""}\n            </div>\n        </div>`}).join("")}function updateStats(e){const t=allActivities.filter(e=>"project"===e.type||"task"===e.type),n=allActivities.filter(e=>"activity"===e.type||"meeting"===e.type);document.getElementById("totalTasks").textContent=t.length,document.getElementById("activeTasks").textContent=t.filter(e=>"active"===e.status).length,document.getElementById("overdueTasks").textContent=t.filter(e=>"overdue"===e.status).length,document.getElementById("completedTasks").textContent=allActivities.filter(e=>"completed"===e.status).length,document.getElementById("activityCount").textContent=n.length}function renderDashboard(){let e=allActivities;"all"!==currentYearFilter&&(e=allActivities.filter(e=>e.startDate&&new Date(e.startDate).getFullYear()==currentYearFilter));let t=e;"all"!==currentMonthFilter&&(t=e.filter(e=>e.startDate&&new Date(e.startDate).getMonth()+1==currentMonthFilter));let n=staffData;"all"!==currentUnitFilter&&(n=staffData.filter(e=>e.unit===currentUnitFilter)),renderGroupTabs(n);const s="all"===currentGroupFilter?n:n.filter(e=>e.group===currentGroupFilter),a=s.map(e=>e.name);let r=t.filter(e=>e.assignees.some(e=>a.includes(e))||e.collaborators&&e.collaborators.some(e=>a.includes(e)));if(currentSearchTerm){const e=currentSearchTerm.toLowerCase();r=r.filter(t=>t.name.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e))}let l=r;"all"!==currentMemberFilter&&(l=r.filter(e=>e.assignees.includes(currentMemberFilter)||e.collaborators&&e.collaborators.includes(currentMemberFilter))),l.sort((e,t)=>new Date(e.startDate)-new Date(t.startDate)),updateStats(allActivities),renderTeamMembers(s,t),renderItems(l.filter(e=>"project"===e.type||"task"===e.type))}function filterByUnit(e){currentUnitFilter=e,currentGroupFilter="all",currentMemberFilter="all",document.querySelectorAll(".unit-tab-btn").forEach(t=>{t.classList.toggle("tab-active",t.id===`tab-unit-${e.replace(/\s/g,"-")}`),t.classList.toggle("bg-gray-100",t.id!==`tab-unit-${e.replace(/\s/g,"-")}`),t.classList.toggle("hover:bg-gray-200",t.id!==`tab-unit-${e.replace(/\s/g,"-")}`)}),renderDashboard()}function filterBySearch(e){currentSearchTerm=e,renderDashboard()}function filterByYear(e){currentYearFilter=e,renderDashboard()}function filterByMonth(e){currentMonthFilter=e,renderDashboard()}function filterByGroup(e){currentGroupFilter=e,currentMemberFilter="all",document.querySelectorAll(".group-tab-btn").forEach(t=>{t.classList.toggle("tab-active",t.id===`tab-${e}`)}),renderDashboard()}function filterByMember(e){currentMemberFilter=currentMemberFilter===e?"all":e,renderDashboard()}function filterItemsByStatus(e,t){currentStatusFilter=e;const n={all:["bg-blue-100","text-blue-700"],planning:["bg-yellow-100","text-yellow-700"],active:["bg-purple-100","text-purple-700"],completed:["bg-green-100","text-green-700"],overdue:["bg-red-100","text-red-700"]};document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active",...Object.values(n).flat()),e.classList.add("bg-gray-100","text-gray-700")}),t.target.classList.add("active",...n[e]),t.target.classList.remove("bg-gray-100","text-gray-700"),renderDashboard()}async function refreshData(){renderYearFilter(),renderMonthFilter(),renderDashboard()}function setupLoginModal(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginModal"),n=document.getElementById("closeModalBtn"),s=document.getElementById("loginForm"),a=document.getElementById("login-message"),r=document.getElementById("loginSubmitBtn"),l=r.querySelector(".btn-text"),i=r.querySelector(".btn-spinner"),o=document.getElementById("togglePassword"),c=document.getElementById("password"),d=document.getElementById("openChangePasswordModalBtn");o.addEventListener("click",function(){const e="password"===c.getAttribute("type")?"text":"password";c.setAttribute("type",e),this.querySelector("i").classList.toggle("fa-eye"),this.querySelector("i").classList.toggle("fa-eye-slash")}),d.addEventListener("click",()=>{t.classList.add("hidden"),document.getElementById("changePasswordModal").classList.remove("hidden")}),e.addEventListener("click",()=>{a.textContent="",s.reset(),t.classList.remove("hidden")}),n.addEventListener("click",()=>t.classList.add("hidden")),t.addEventListener("click",e=>{e.target===t&&t.classList.add("hidden")}),s.addEventListener("submit",async e=>{e.preventDefault();const t=e.target.username.value,n=e.target.password.value;a.textContent="",l.textContent="ç™»å…¥ä¸­...",i.classList.remove("hidden"),r.disabled=!0;try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"login",username:t,password:n}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!e.ok)throw Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${e.status} ${e.statusText}`);const s=await e.json();if("success"!==s.status)throw Error(s.message||"å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚");{const e=s.data;a.textContent="ç™»å…¥æˆåŠŸï¼å³å°‡è·³è½‰...",a.className="text-center mb-4 font-medium text-green-500",setTimeout(()=>{window.location.href=`https://luyun1224.github.io/cmh4200/project-admin.html?user=${encodeURIComponent(e.name)}&id=${e.employeeId}`},1500)}}catch(e){console.error("Login Error Details:",e),a.textContent=e.message,a.className="text-center mb-4 font-medium text-red-500"}finally{l.textContent="ç™»å…¥",i.classList.add("hidden"),r.disabled=!1}})}function setupChangePasswordModal(){const e=document.getElementById("changePasswordModal"),t=document.getElementById("changePasswordForm"),n=document.getElementById("change-password-message"),s=document.getElementById("changePasswordSubmitBtn"),a=document.getElementById("closeChangePasswordModalBtn");a.addEventListener("click",()=>{e.classList.add("hidden"),document.getElementById("loginModal").classList.remove("hidden")}),t.addEventListener("submit",async e=>{e.preventDefault();const a=t.elements.employeeId.value,r=t.elements.oldPassword.value,l=t.elements.newPassword.value;n.textContent="",s.disabled=!0,s.querySelector(".btn-text").textContent="è™•ç†ä¸­...",s.querySelector(".btn-spinner").classList.remove("hidden");try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"updatePassword",employeeId:a,oldPassword:r,newPassword:l}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!e.ok)throw Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");const i=await e.json();if("success"!==i.status)throw Error(i.message||"æ›´æ–°å¤±æ•—");n.textContent="å¯†ç¢¼æ›´æ–°æˆåŠŸï¼",n.className="text-center mb-4 font-medium text-green-500",t.reset()}catch(e){n.textContent=e.message,n.className="text-center mb-4 font-medium text-red-500"}finally{s.disabled=!1,s.querySelector(".btn-text").textContent="ç¢ºèªæ›´æ›",s.querySelector(".btn-spinner").classList.add("hidden")}})}function openActivityModal(e=!0){e&&(calendarDate=new Date);const t=document.getElementById("activityModal"),n=document.getElementById("activity-content"),s=new Date;s.setHours(0,0,0,0);const a=allActivities.filter(e=>{const t=e.type&&("activity"===e.type.toLowerCase()||"meeting"===e.type.toLowerCase());return t}),r=generateCalendarHTML(calendarDate.getFullYear(),calendarDate.getMonth(),a);if(0===a.length)return n.innerHTML=r+'<p class="text-center text-gray-500 mt-4">ç›®å‰æ²’æœ‰ä»»ä½•æ´»å‹•ã€‚</p>',void t.classList.remove("hidden");const l=a.slice().sort((e,t)=>{const n=new Date(e.startDate),a=new Date(t.startDate),r=(e.deadline?new Date(e.deadline):n)<s,l=(t.deadline?new Date(t.deadline):a)<s;return r!==l?r?1:-1:n-a}),i=e=>{if(0===e.length)return'<p class="text-center text-gray-500 mt-4">æ­¤æœˆä»½æ²’æœ‰æ´»å‹•åˆ—è¡¨ã€‚</p>';let t="",n="";return e.forEach(e=>{const a=new Date(e.startDate),r=`${a.getFullYear()}-${a.getMonth()+1}`;r!==n&&(n&&(t+="</ul></div>"),n=r,t+=`<div class="mt-4"><h3 class="text-2xl font-bold text-purple-700 mb-2">${a.getFullYear()}å¹´${a.getMonth()+1}æœˆ</h3><ul class="space-y-4">`);const l=a.getDate(),i=e.deadline&&e.deadline!==e.startDate?` - ${formatDate(e.deadline)}`:"",o=(e.deadline,new Date(e.startDate)<s);t+=`<li class="relative flex items-start space-x-4 p-2 rounded-lg ${o?"bg-gray-100":"hover:bg-gray-50"}">\n                        ${o?'<span class="absolute top-1 right-1 text-xs bg-gray-200 text-gray-600 px-1 rounded">å·²éæœŸ</span>':""}\n                        <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-purple-100 rounded-lg">\n                        <span class="text-xl font-bold text-purple-700">${l}</span>\n                        </div>\n                        <div class="flex-grow pt-1">\n                        <p class="font-semibold text-gray-800">${e.name}</p>\n                        <p class="text-sm text-gray-600">æ—¥æœŸ: ${formatDate(e.startDate)}${i}</p>\n                        <p class="text-sm text-gray-500">è² è²¬äºº: ${e.assignees.join(", ")}</p>\n                        ${e.collaborators&&e.collaborators.length>0?`<p class="text-sm text-gray-500">å”åŠ©: ${e.collaborators.join(", ")}</p>`:""}\n                        </div>\n                        </li>`}),n&&(t+="</ul></div>"),t};n.innerHTML=r+'<hr class="my-6"/>'+`<div class="space-y-6">${i(l)}</div>`,t.classList.remove("hidden")}function showItemsInModal(e){const t=document.getElementById("itemListModal"),n=document.getElementById("itemListModalTitle"),s=document.getElementById("itemListModalContent");let a=[],r="";const l=allActivities.filter(e=>"project"===e.type||"task"===e.type),i={active:1,planning:2,overdue:3,completed:4};switch(e){case"total":a=l.sort((e,t)=>(i[e.status]||99)-(i[t.status]||99)),r="ç¸½é …ç›®åˆ—è¡¨";break;case"active":a=l.filter(e=>"active"===e.status),r="é€²è¡Œä¸­é …ç›®åˆ—è¡¨";break;case"overdue":a=l.filter(e=>"overdue"===e.status),r="é€¾æœŸé …ç›®åˆ—è¡¨";break;case"completed":a=allActivities.filter(e=>"completed"===e.status),r="å·²å®Œæˆé …ç›®åˆ—è¡¨"}n.innerHTML=`<i class="fas fa-list-check mr-3"></i> ${r} (${a.length})`,0===a.length?s.innerHTML='<p class="text-center text-gray-500 py-4">æ­¤é¡åˆ¥ä¸­æ²’æœ‰é …ç›®ã€‚</p>':s.innerHTML=a.map(e=>`\n            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100">\n                <p class="font-semibold text-gray-800">${e.name}</p>\n                <p class="text-sm text-gray-600">è² è²¬äºº: ${e.assignees.join(", ")}</p>\n                <div class="flex justify-between items-center text-xs mt-1">\n                    <span class="font-medium ${getTypeStyle(e.type,e.status)}">(${getTypeText(e.type)})</span>\n                    <span class="px-2 py-0.5 text-xs font-medium rounded-full ${getStatusColor(e.status)} text-white">${getStatusText(e.status)}</span>\n                </div>\n            </div>\n        `).join(""),t.classList.remove("hidden")}async function getAiSuggestions(e="all"){const t=document.getElementById("ai-suggestion-content"),n=["æ­£åœ¨æº–å‚™æ‚¨çš„å°ˆæ¡ˆæ•¸æ“š...","å·²é€£ç·šè‡³ AI å¼•æ“...","AI æ­£åœ¨åˆ†æé¢¨éšªèˆ‡æ©Ÿæœƒ...","ç”Ÿæˆå€‹äººåŒ–æ±ºç­–å»ºè­°ä¸­...","å¹¾ä¹å®Œæˆäº†..."];let s=0;t.innerHTML=`\n        <div class="flex flex-col items-center justify-center p-8">\n            <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>\n            <p id="ai-loading-message" class="mt-4 text-gray-600 font-medium">${n[0]}</p>\n        </div>`;const a=document.getElementById("ai-loading-message"),r=setInterval(()=>{s=(s+1)%n.length,a&&(a.textContent=n[s])},1500);let l=allActivities.filter(e=>["project","task"].includes(e.type)),i="æ•´å€‹åœ˜éšŠ";"all"!==e&&(i=e,l=l.filter(t=>t.assignees.includes(e)||t.collaborators&&t.collaborators.includes(e)));const o=l.length,c=l.filter(e=>"overdue"===e.status),d=l.filter(e=>"active"===e.status),u=l.filter(e=>"planning"===e.status),p=l.filter(e=>"completed"===e.status),g=l.filter(e=>e.progress>85&&"active"===e.status),m=d.filter(e=>e.progress-(e.lastWeekProgress||0)<=0&&e.lastWeekProgress>0),f=`\n        ä½ æ˜¯ä¸€ä½é ‚å°–çš„å°ˆæ¡ˆç®¡ç†èˆ‡ç­–ç•¥é¡§å•ï¼Œå°ˆç²¾æ–¼é†«ç™‚æ•™è‚²é ˜åŸŸã€‚è«‹ç‚ºä¸€ä½é«˜éšç¶“ç†äººï¼Œé‡å° **${i}** çš„è¡¨ç¾ï¼Œæ’°å¯«ä¸€ä»½æ·±å…¥çš„æ±ºç­–æ‘˜è¦ã€‚\n        è«‹å‹™å¿…ä½¿ç”¨ **ç¹é«”ä¸­æ–‡**ï¼Œä¸¦æ ¹æ“šæˆ‘æä¾›çš„ **çœŸå¯¦æ•¸æ“š** å’Œ **å¤–éƒ¨æƒ…è³‡**ï¼Œç”Ÿæˆä¸€å€‹åŒ…å«å¤šå…ƒæ´è¦‹çš„ JSON ç‰©ä»¶ã€‚\n\n        **å…§éƒ¨æ•¸æ“šæ‘˜è¦ (Internal Data):**\n        - **åˆ†æå°è±¡:** ${i}\n        - **è² è²¬ç¸½é …ç›®æ•¸:** ${o}\n        - **é …ç›®ç‹€æ…‹:**\n            - é€¾æœŸ: ${c.length} é …\n            - é€²è¡Œä¸­: ${d.length} é …\n            - è¦åŠƒä¸­: ${u.length} é …\n            - å·²å®Œæˆ: ${p.length} é …\n        - **éœ€ç«‹å³é—œæ³¨çš„é€¾æœŸé …ç›®:** ${c.length>0?c.map(e=>`"${e.name}"`).join("; "):"ç„¡"}\n        - **é€²åº¦å¯èƒ½åœæ»¯çš„é …ç›® (ä¸€é€±å…§ç„¡é€²å±•):** ${m.length>0?m.map(e=>`"${e.name}"`).join("; "):"ç„¡"}\n        - **è¡¨ç¾å„ªç•°çš„é …ç›® (é€²åº¦ > 85%):** ${g.length>0?g.map(e=>`"${e.name}"`).join("; "):"ç„¡"}\n\n        **å¤–éƒ¨æƒ…è³‡ (External Intelligence):**\n        - **é†«ç™‚æ•™è‚²è¶¨å‹¢:** æ•¸ä½è½‰å‹å’Œæ¨¡æ“¬é†«å­¸(Simulation-Based Medical Education)æ˜¯ä¸»æµï¼Œå¼·èª¿ä½¿ç”¨VR/ARå’Œç·šä¸Šå¹³å°æå‡å­¸ç¿’æˆæ•ˆã€‚AIè¼”åŠ©è¨ºæ–·èˆ‡æ•™å­¸æ—¥ç›Šé‡è¦ã€‚\n        - **å°ˆæ¡ˆç®¡ç†è¶¨å‹¢:** æ•æ·(Agile)èˆ‡æ··åˆå¼å°ˆæ¡ˆç®¡ç†æ–¹æ³•è«–è¢«å»£æ³›æ¡ç”¨ï¼Œä»¥æ‡‰å°å¿«é€Ÿè®ŠåŒ–çš„éœ€æ±‚ã€‚åˆ©ç”¨AIå·¥å…·é€²è¡Œé¢¨éšªé æ¸¬èˆ‡è³‡æºåˆ†é…æ˜¯å‰ç·£å¯¦è¸ã€‚\n\n        è«‹åŸºæ–¼ä»¥ä¸Šå…§å¤–éƒ¨è³‡è¨Šï¼Œå¡«å……ä»¥ä¸‹ JSON çµæ§‹ã€‚è«‹æä¾›å…·é«”ã€å¯åŸ·è¡Œçš„åˆ†æèˆ‡å»ºè­°ï¼Œè€Œä¸åƒ…åƒ…æ˜¯é‡è¤‡æ•¸æ“šã€‚\n    `,y={contents:[{role:"user",parts:[{text:f}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{healthOverview:{type:"OBJECT",description:"å°æ•´é«”å°ˆæ¡ˆçµ„åˆçš„å¥åº·åº¦é€²è¡Œå¿«é€Ÿç¸½çµã€‚",properties:{summary:{type:"STRING",description:"ç”¨1-2å¥è©±ç¸½çµç›®å‰å°ˆæ¡ˆçµ„åˆçš„æ•´é«”å¥åº·åº¦ï¼Œé»å‡ºæœ€é—œéµçš„æŒ‘æˆ°èˆ‡å„ªå‹¢ã€‚"},ragAnalysis:{type:"ARRAY",description:"RAGç‡ˆè™Ÿåˆ†æåˆ—è¡¨ï¼Œæ¯å€‹ç‡ˆè™Ÿä¸€å€‹ç‰©ä»¶ã€‚",items:{type:"OBJECT",properties:{status:{type:"STRING",description:"ç‡ˆè™Ÿç‹€æ…‹ (ä¾‹å¦‚: ç´…ç‡ˆ (é€¾æœŸ), é»ƒç‡ˆ (é€²è¡Œä¸­), è—ç‡ˆ (è¦åŠƒä¸­), ç¶ ç‡ˆ (å·²å®Œæˆ))"},count:{type:"NUMBER",description:"è©²ç‹€æ…‹çš„é …ç›®æ•¸é‡"},example:{type:"STRING",description:"å¦‚æœæ˜¯ç´…ç‡ˆï¼Œæä¾›ä¸€å€‹æœ€é—œéµçš„é€¾æœŸé …ç›®åç¨±ä½œç‚ºç¯„ä¾‹ã€‚å…¶ä»–ç‹€æ…‹å‰‡ç‚ºç©ºå­—ä¸²ã€‚"}}}}}},opportunities:{type:"ARRAY",description:"æ ¹æ“šæ•¸æ“šè­˜åˆ¥å‡ºçš„äº®é»èˆ‡æ©Ÿæœƒã€‚",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"æ©Ÿæœƒé»çš„æ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'é«˜ç¸¾æ•ˆå°ˆæ¡ˆ' æˆ– 'æ½›åŠ›é ˜åŸŸ'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"åˆ—å‡ºå…·é«”çš„é …ç›®æˆ–è§€å¯Ÿï¼Œä¸¦èªªæ˜ç‚ºä½•é€™æ˜¯å€‹æ©Ÿæœƒé»ã€‚"}}}},riskAssessment:{type:"ARRAY",description:"éœ€è¦ç®¡ç†è€…é—œæ³¨çš„é¢¨éšªã€‚",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"é¢¨éšªæ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'é€¾æœŸé …ç›®è¡æ“Š' æˆ– 'é€²åº¦åœæ»¯è­¦ç¤º'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"åˆ—å‡ºå…·é«”çš„é¢¨éšªé …ç›®ï¼Œä¸¦ç°¡è¦èªªæ˜å…¶æ½›åœ¨å½±éŸ¿ã€‚"}}}},recommendations:{type:"ARRAY",description:"åŸºæ–¼ä¸Šè¿°åˆ†æï¼Œæä¾›çµ¦ç®¡ç†è€…çš„å…·é«”ã€å¯æ“ä½œçš„å»ºè­°ã€‚",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"å»ºè­°çš„æ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'å„ªå…ˆè™•ç†äº‹é …' æˆ– 'ç­–ç•¥æ€§æŠ•å…¥'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"æå‡ºå…·é«”çš„è¡Œå‹•æ­¥é©Ÿï¼Œä¾‹å¦‚å¬é–‹ç‰¹å®šæœƒè­°ã€èª¿æ•´è³‡æºã€å¼•å…¥æ–°å·¥å…·æˆ–æ–¹æ³•ç­‰ã€‚"}}}},industryInsights:{type:"ARRAY",description:"çµåˆå¤–éƒ¨æƒ…è³‡ï¼Œæä¾›èˆ‡ç•¶å‰å°ˆæ¡ˆç›¸é—œçš„å®è§€ç­–ç•¥æ´è¦‹ã€‚",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"æ´å¯Ÿçš„æ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'é€£çµæ•¸ä½è½‰å‹è¶¨å‹¢' æˆ– 'å°å…¥æ•æ·ç®¡ç†æ€ç¶­'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"èªªæ˜å¦‚ä½•å°‡å¤–éƒ¨è¶¨å‹¢æ‡‰ç”¨æ–¼ç•¶å‰å°ˆæ¡ˆæˆ–æœªä¾†è¦åŠƒä¸­ã€‚"}}}}}}}};try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"getAiSuggestionProxy",payload:y})});if(!e.ok){const t=await e.json().catch(()=>({message:e.statusText}));throw Error(`ä»£ç†ä¼ºæœå™¨è«‹æ±‚å¤±æ•—: ${t.message||e.statusText}`)}const n=await e.json();if(!(n.candidates&&n.candidates.length>0&&n.candidates[0].content.parts[0].text))throw Error("AI æœªèƒ½æä¾›æœ‰æ•ˆçš„å»ºè­°ã€‚å›æ‡‰ç‚ºç©ºæˆ–æ ¼å¼ä¸ç¬¦ã€‚");{const e=n.candidates[0].content.parts[0].text,s=JSON.parse(e);t.innerHTML=renderAiReport(s)}}catch(e){console.error("AI Suggestion Error:",e),t.innerHTML=`\n            <div class="p-4 bg-red-100 text-red-700 rounded-lg">\n                <p class="font-bold">ç„¡æ³•ç²å– AI å»ºè­°</p>\n                <p>${e.message}</p>\n            </div>`}finally{clearInterval(r)}}function renderAiReport(e){const{healthOverview:t={},opportunities:n=[],riskAssessment:s=[],recommendations:a=[],industryInsights:r=[]}=e,l=(e,t,n,s,a)=>a?"":`\n            <div class="mb-6">\n                <h3 class="text-lg font-bold ${t} flex items-center mb-3"><i class="fas ${n} fa-fw mr-3"></i>${e}</h3>\n                <div class="pl-5 space-y-4">${s}</div>\n            </div>\n        `,i=e=>{if(!Array.isArray(e)||0===e.length)return'<p class="text-sm text-gray-500">ç„¡å…·é«”é …ç›®ã€‚</p>';let t='<ul class="list-none space-y-2">';return t+=e.map(e=>`\n            <li class="flex items-start">\n                <span class="mr-3 text-gray-500 mt-1.5 text-xs">â—</span>\n                <span class="text-gray-800 flex-1 text-sm">${e}</span>\n            </li>\n        `).join(""),t+="</ul>"},o=(e,t,n)=>Array.isArray(e)&&0!==e.length?e.map(e=>{const s=n[e.title]||"fa-lightbulb";return`<div class="space-y-2"><strong class="font-bold ${t} flex items-center text-sm"><i class="fas ${s} w-5 text-center mr-2"></i>${e.title}</strong><div class="pl-5">${i(e.points)}</div></div>`}).join('<hr class="my-4 border-gray-200">'):'<p class="pl-5 text-sm text-gray-500">ç„¡</p>',c=`\n        <p class="text-gray-700 mb-4">${t.summary||"ç„¡æ³•ç”Ÿæˆç¸½çµã€‚"}</p>\n        <ul class="space-y-2 pl-4">\n        ${(t.ragAnalysis||[]).map(e=>{let t="text-gray-600",n="fa-info-circle";e.status.includes("ç´…")||e.status.includes("é€¾æœŸ")?(t="text-red-600",n="fa-exclamation-triangle"):e.status.includes("é»ƒ")||e.status.includes("é€²è¡Œä¸­")?(t="text-yellow-600",n="fa-tasks"):e.status.includes("è—")||e.status.includes("è¦åŠƒä¸­")?(t="text-blue-600",n="fa-map"):(e.status.includes("ç¶ ")||e.status.includes("å·²å®Œæˆ"))&&(t="text-green-600",n="fa-check-circle");const s=e.example?` ("${e.example}")`:"";return`<li class="flex items-start">\n                        <i class="fas ${n} ${t} w-5 mt-1 mr-3"></i>\n                        <span class="font-semibold text-gray-800">${e.status}: ${e.count} é …${s}</span>\n                    </li>`}).join("")}\n        </ul>\n    `,d=o(n,"text-teal-600",{"é«˜ç¸¾æ•ˆå°ˆæ¡ˆ":"fa-award","æ½›åŠ›é ˜åŸŸ":"fa-search-plus"}),u=o(s,"text-red-800",{"é€¾æœŸé …ç›®è¡æ“Š":"fa-fire-alt","é€²åº¦åœæ»¯è­¦ç¤º":"fa-ghost"}),p=o(a,"text-blue-800",{"å„ªå…ˆè™•ç†äº‹é …":"fa-star","ç­–ç•¥æ€§æŠ•å…¥":"fa-chess-knight"}),g=o(r,"text-indigo-800",{"é€£çµæ•¸ä½è½‰å‹è¶¨å‹¢":"fa-laptop-medical","å°å…¥æ•æ·ç®¡ç†æ€ç¶­":"fa-running"});let m='<div class="space-y-6">';return m+=l("å°ˆæ¡ˆçµ„åˆå¥åº·åº¦é€Ÿè¦½ (RAG åˆ†æ)","text-gray-700","fa-chart-pie",c,!t.summary),m+=l("æ©Ÿæœƒé»èˆ‡äº®é»","text-teal-600","fa-sun",d,0===n.length),m+=l("é¢¨éšªè©•ä¼°èˆ‡é è­¦","text-red-600","fa-shield-alt",u,0===s.length),m+=l("å…·é«”è¡Œå‹•å»ºè­°","text-blue-600","fa-user-tie",p,0===a.length),m+=l("å¤–éƒ¨è¶¨å‹¢èˆ‡ç­–ç•¥æ´å¯Ÿ","text-indigo-600","fa-globe-asia",g,0===r.length),m+="</div>"}function generateWeeklySummary(){const e=document.getElementById("weeklySummaryModal"),t=document.getElementById("weekly-summary-content");t.innerHTML='<div class="p-8 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-2xl text-green-500 mr-3"></i> æ­£åœ¨ç”Ÿæˆæœ¬é€±å›é¡§...</div>';const n=new Date,s=new Date;s.setDate(n.getDate()-7);const a=new Date;a.setDate(n.getDate()+7);const r=allActivities.filter(e=>["project","task"].includes(e.type)),l=r.filter(e=>{if("completed"!==e.status)return!1;const t=e.deadline?new Date(e.deadline):null;if(!t)return!1;const a=t>=s&&t<=n,r=100===(e.lastWeekProgress||0);return a&&!r}),i=r.filter(e=>"completed"!==e.status&&e.progress>(e.lastWeekProgress||0)),o=r.filter(e=>new Date(e.startDate)>=s&&new Date(e.startDate)<=n),c=r.filter(e=>"active"===e.status&&e.progress===(e.lastWeekProgress||0)),d=r.filter(e=>e.deadline&&new Date(e.deadline)>n&&new Date(e.deadline)<=a&&"completed"!==e.status),u=r.filter(e=>e.helpMessage&&""!==e.helpMessage.trim());let p="";const g=(e,t,n,s,a)=>{let r=`<div class="mb-4">\n            <h3 class="text-lg font-bold ${n} flex items-center mb-2"><i class="fas ${t} fa-fw mr-2"></i>${e} (${s.length})</h3>`;return s.length>0?(r+='<ul class="space-y-2 pl-5">',r+=s.map(t=>`<li class="text-sm text-gray-800 p-2 bg-gray-50 rounded-md border-l-4 ${n.replace("text-","border-")}">\n                    <strong>${t.name}</strong> - <span class="text-gray-500">è² è²¬äºº: ${t.assignees.join(", ")}</span>\n                    ${e.includes("é€²åº¦")?`<span class="font-medium text-green-600"> (+${t.progress-(t.lastWeekProgress||0)}%)</span>`:""}\n                    ${e.includes("åˆ°æœŸ")?`<span class="font-medium text-yellow-800"> (åˆ°æœŸæ—¥: ${formatDate(t.deadline)})</span>`:""}\n                    ${e.includes("å”åŠ©")?`<p class="text-sm text-red-700 mt-1 pl-2 border-l-2 border-red-200 bg-red-50 py-1"><em>"${t.helpMessage}"</em></p>`:""}\n                </li>`).join(""),r+="</ul>"):r+=`<p class="pl-5 text-sm text-gray-500">${a}</p>`,r+="</div>"};p+=g("æœ¬é€±å®Œæˆé …ç›®","fa-check-circle","text-green-600",l,"æœ¬é€±æ²’æœ‰å®Œæˆçš„é …ç›®ã€‚"),p+=g("æœ¬é€±é€²åº¦æ›´æ–°","fa-rocket","text-blue-600",i,"æœ¬é€±æ²’æœ‰é …ç›®å–å¾—é€²å±•ã€‚"),p+=g("æœ¬é€±æ–°å¢é …ç›®","fa-lightbulb","text-purple-600",o,"æœ¬é€±æ²’æœ‰æ–°å¢é …ç›®ã€‚"),p+=g("ä¸‹é€±åˆ°æœŸé …ç›®","fa-clock","text-yellow-600",d,"ä¸‹é€±æ²’æœ‰å³å°‡åˆ°æœŸçš„é …ç›®ã€‚"),p+=g("é€²åº¦åœæ»¯é …ç›®","fa-pause-circle","text-orange-500",c,"æ‰€æœ‰é …ç›®çš†æœ‰é€²å±•ï¼Œå¤ªæ£’äº†ï¼"),p+=g("éœ€è¦å”åŠ©é …ç›®","fa-hands-helping","text-red-600",u,"æ²’æœ‰é …ç›®ç™¼å‡ºæ±‚æ•‘ä¿¡è™Ÿã€‚"),t.innerHTML=p}function setupModal(e,t,n,s){const a=document.getElementById(e),r=t?document.getElementById(t):null,l=document.getElementById(n),i=()=>{a.classList.remove("hidden"),s&&s()},o=()=>a.classList.add("hidden");r&&r.addEventListener("click",i),l.addEventListener("click",o),a.addEventListener("click",e=>{e.target===a&&o()})}function setupAiModal(){const e=document.getElementById("aiModal"),t=document.getElementById("aiBtn"),n=document.getElementById("closeAiModalBtn"),s=document.getElementById("aiMemberFilter"),a=()=>{s.innerHTML='<option value="all">ç¸½é«”åˆ†æ</option>',staffData.forEach(e=>{s.innerHTML+=`<option value="${e.name}">${e.name}</option>`}),s.value="all",e.classList.remove("hidden"),getAiSuggestions("all")},r=()=>e.classList.add("hidden");t.addEventListener("click",a),n.addEventListener("click",r),e.addEventListener("click",t=>{t.target===e&&r()}),s.addEventListener("change",e=>{getAiSuggestions(e.target.value)})}function setupActivityModal(){setupModal("activityModal",null,"closeActivityModalBtn")}function setupWeeklySummaryModal(){setupModal("weeklySummaryModal","weeklySummaryBtn","closeWeeklySummaryBtn",generateWeeklySummary)}function setupItemListModal(){setupModal("itemListModal",null,"closeItemListModalBtn")}function navigateCalendar(e){calendarDate.setMonth(calendarDate.getMonth()+e),openActivityModal(!1)}function generateCalendarHTML(e,t,n){const s={};n.forEach(n=>{if(!n.startDate)return;const a=new Date(n.startDate),r=n.deadline?new Date(n.deadline):new Date(n.startDate);for(let l=new Date(a);l<=r;l.setDate(l.getDate()+1))if(l.getFullYear()===e&&l.getMonth()===t){const e=l.getDate();s[e]||(s[e]=[]),s[e].push(n)}});const a=["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"],r=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"],l=new Date(e,t,1).getDay(),i=new Date(e,t+1,0).getDate();let o=`<div class="mb-6">\n        <div class="flex justify-between items-center mb-4">\n            <button onclick="navigateCalendar(-1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">&lt;</button>\n            <h3 class="text-xl font-bold text-purple-700">${e}å¹´ ${a[t]}</h3>\n            <button onclick="navigateCalendar(1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">&gt;</button>\n        </div>\n        <div class="grid grid-cols-7 gap-1 text-center text-sm">`;r.forEach(e=>{o+=`<div class="font-semibold text-gray-600">${e}</div>`});for(let e=0;e<l;e++)o+="<div></div>";for(let e=1;e<=i;e++){const t=s[e];if(t){const n=t.map(e=>`<li class="truncate">${e.name}</li>`).join("");o+=`<div class="relative group flex items-center justify-center">\n                <div class="mx-auto flex items-center justify-center w-8 h-8 rounded-full border-2 border-purple-400 text-purple-700 font-semibold cursor-pointer">${e}</div>\n                <span class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs bg-red-500 text-white rounded-full">${t.length}</span>\n                <div class="absolute bottom-full mb-2 w-56 p-2 bg-slate-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20 transform -translate-x-1/2 left-1/2">\n                    <ul class="space-y-1">${n}</ul>\n                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>\n                </div>\n            </div>`}else o+=`<div class="flex items-center justify-center w-8 h-8">${e}</div>`}return o+="</div></div>"}function setupScrollToTop(){const e=document.getElementById("scrollToTopBtn");window.onscroll=(()=>{document.body.scrollTop>20||document.documentElement.scrollTop>20?e.classList.remove("hidden"):e.classList.add("hidden")}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})}function viewMemberHistory(e,t){t.stopPropagation(),"ç›§è‹±äº‘"!==e?alert(`æª¢è¦– ${e} çš„å€‹äººæ­·ç¨‹ (åŠŸèƒ½é–‹ç™¼ä¸­)`):window.open("https://qpig0218.github.io/Ying-Yun/","_blank")}function generateDashboardReportHTML(){const e=new Date,t=e.toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}),n=e.getMonth()+1,s=e.getFullYear(),a=allActivities.filter(e=>{const t=new Date(e.startDate);return t.getFullYear()===s&&t.getMonth()+1===n}),r=a.filter(e=>"completed"===e.status&&"project"===e.type).length,l=a.filter(e=>"completed"===e.status&&"task"===e.type).length,i=allActivities.filter(e=>"active"===e.status&&"project"===e.type).length,o=allActivities.filter(e=>"active"===e.status&&"task"===e.type).length,c=allActivities.filter(e=>"overdue"===e.status),d=allActivities.filter(t=>"completed"===t.status&&new Date(t.deadline)<=e&&"project"===t.type).sort((e,t)=>new Date(t.deadline)-new Date(e.deadline)),u=d.length>0?d[0]:null,p=a.filter(e=>"completed"===e.status&&"task"===e.type).map(e=>e.name).slice(0,2),g=new Date(e);g.setDate(e.getDate()+7);const m=allActivities.filter(t=>{const n=new Date(t.startDate);return"completed"!==t.status&&n>e&&n<=g}).map(e=>`[${formatDate(e.startDate)}]: ${e.name}`);let f='<div class="p-2 space-y-4 text-gray-800">';if(f+=`<p>æ‚¨å¥½ï¼é€™æ˜¯æˆªè‡³ <strong>${t}</strong> çš„æœ¬æœˆé‡é»å½™å ±ã€‚</p>`,f+='<div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">\n        <h3 class="font-bold text-yellow-800">â­ æœ¬æœˆäº®é» (Highlights)</h3>\n        <ul class="list-none text-sm text-yellow-700 mt-2 space-y-1">',f+=`<li><span class="font-semibold">ğŸ‰ å°ˆæ¡ˆé”æ¨™ï¼š</span> æœ¬æœˆå…±å®Œæˆ <strong>${r}</strong> é …å°ˆæ¡ˆã€<strong>${l}</strong> é …ä»»å‹™ï¼</li>`,f+=u?`<li><span class="font-semibold">ğŸš€ æŒ‡æ¨™å°ˆæ¡ˆä¸Šç·šï¼š</span> ã€Œ${u.name}ã€å·²æ–¼ ${formatDate(u.deadline)} é †åˆ©å®Œæˆã€‚</li>`:'<li><span class="font-semibold">ğŸš€ æŒ‡æ¨™å°ˆæ¡ˆä¸Šç·šï¼š</span> æœ¬æœˆå°šç„¡æŒ‡æ¨™å°ˆæ¡ˆå®Œæˆã€‚</li>',f+="</ul></div>",f+=`<div class="p-3 bg-blue-50 rounded-lg border border-blue-200">\n        <h3 class="font-bold text-blue-800">âš™ï¸ å°ˆæ¡ˆé€²åº¦ (Project Progress)</h3>\n        <ul class="list-none text-sm text-blue-700 mt-2 space-y-1">\n            <li><strong>é€²è¡Œä¸­å°ˆæ¡ˆï¼š</strong> ${i} é …</li>\n            <li><strong>é€²è¡Œä¸­ä»»å‹™ï¼š</strong> ${o} é …</li>\n            <li><strong>æœ¬æœˆå®Œæˆé‡Œç¨‹ç¢‘ï¼š</strong> ${p.length>0?p.join(", "):"ç„¡"}</li>\n        </ul></div>`,c.length>0){const e=c[0];f+=`<div class="p-3 bg-red-50 rounded-lg border border-red-200">\n            <h3 class="font-bold text-red-800">âš ï¸ é¢¨éšªæç¤º</h3>\n            <p class="text-sm text-red-700 mt-1">ã€Œ${e.name}ã€ç›®å‰è™•æ–¼é€¾æœŸç‹€æ…‹ï¼Œéœ€è² è²¬äºº <strong>${e.assignees.join(", ")}</strong> é‡é»é—œæ³¨ã€‚</p>\n            </div>`}return f+='<div class="p-3 bg-green-50 rounded-lg border border-green-200">\n        <h3 class="font-bold text-green-800">ğŸ—“ï¸ ä¸‹é€±é‡é»é å‘Š (Coming Up)</h3>',m.length>0?f+=`<ul class="list-none text-sm text-green-700 mt-2 space-y-1">\n            ${m.map(e=>`<li>${e}</li>`).join("")}\n            </ul>`:f+='<p class="text-sm text-green-700 mt-1">ä¸‹é€±å°šç„¡æ’å®šé‡é»äº‹é …ã€‚</p>',f+="</div>",f+='<p class="text-xs text-gray-500 text-center pt-2">å¸Œæœ›é€™ä»½å½™å ±å°æ‚¨æœ‰å¹«åŠ©ï¼</p>',f+="</div>"}function setupChatBot(){const e=document.getElementById("openChatBot"),t=document.getElementById("closeChatBot"),n=document.getElementById("chatBotContainer"),s=document.getElementById("chatBotMessages");e.addEventListener("click",()=>{n.classList.remove("hidden"),s.innerHTML='<div class="p-4"><i class="fas fa-spinner fa-spin text-indigo-500"></i> æ­£åœ¨ç”¢ç”Ÿå ±å‘Š...</div>',setTimeout(()=>{s.innerHTML=generateDashboardReportHTML()},100)}),t.addEventListener("click",()=>{n.classList.add("hidden")})}async function initializeDashboard(){const e=document.getElementById("loadingOverlay"),t=document.getElementById("errorDisplay");e.classList.remove("hidden");try{const n=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"getDashboardData"}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!n.ok)throw Error(`Network response was not ok: ${n.statusText}`);const s=await n.json();if("success"!==s.status)throw Error(s.message);const a=s.data.staffData||[];staffData=a.map(e=>({id:e.employeeId,name:e.name,group:e.group,birthday:e.birthday,unit:e.unit}));const r=s.data.activities||[],l=new Date;l.setHours(0,0,0,0),allActivities=r.map(e=>{const t=parseInt(e.progress,10)||0,n=e.deadline?new Date(e.deadline):null;let s=e.status||"planning";return t>=100?s="completed":"completed"!==s&&n&&n<l&&(s="overdue"),{...e,progress:t,status:s,lastWeekProgress:e.lastWeekProgress?parseInt(e.lastWeekProgress,10):0,helpMessage:e.helpMessage||"",checklist:Array.isArray(e.checklist)?e.checklist:[]}});const i=new URLSearchParams(window.location.search),o=i.get("status");if(o&&(currentStatusFilter=o),renderUnitTabs(),renderYearFilter(),renderMonthFilter(),renderDashboard(),o){const e=document.querySelector(`.filter-btn[onclick*="${o}"]`);e&&filterItemsByStatus(o,{target:e})}document.getElementById("openChatBot").classList.remove("hidden")}catch(e){console.error("Initialization failed:",e),document.getElementById("errorMessage").textContent=`ç„¡æ³•å¾ä¼ºæœå™¨ç²å–å°ˆæ¡ˆæ•¸æ“šã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚(${e.message})`,t.classList.remove("hidden")}finally{e.classList.add("hidden")}}document.addEventListener("DOMContentLoaded",async function(){setupLoginModal(),setupChangePasswordModal(),setupAiModal(),setupActivityModal(),setupWeeklySummaryModal(),setupScrollToTop(),setupItemListModal(),setupChatBot(),await initializeDashboard()});
