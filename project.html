<!DOCTYPE html>
<html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>æ•™å­¸éƒ¨-å°ˆæ¡ˆé€²åº¦å„€è¡¨æ¿ (å„ªåŒ–ç‰ˆ)</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://script.google.com"><script src="https://cdn.tailwindcss.com"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet"><style>body{font-family:'Noto Sans TC',sans-serif;background-color:#f0f4f8}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:8px}.progress-bar{transition:width .5s ease-in-out}.tab-active{background-color:rgb(20,53,114);color:#fff;box-shadow:0 4px 6px -1px #0000001a,0 2px 4px -2px #0000001a}#loginModal,#aiModal,#activityModal,#weeklySummaryModal,#loadingOverlay,#itemListModal,#changePasswordModal{z-index:50}.ai-content h3,.activity-content h3{font-size:1.25rem;font-weight:700;margin-top:1.5rem;margin-bottom:1rem;border-bottom:1px solid #e5e7eb;padding-bottom:.5rem;color:#4b5563}.ai-content p{margin-bottom:.5rem}.filter-btn.active{font-weight:700;transform:translateY(-2px);box-shadow:0 4px 8px #0000001a}:root{--deep-blue:#1a3a6e;--dark-maroon:#a52326;--orange-yellow:#f8b52c;--dark-green:#106a3f;--light-blue:#c3dfe5;--light-purple:#ad91c3;--dark-gray:#3e3a38}.text-blue-700{color:var(--deep-blue)!important}.bg-blue-600{background-color:var(--deep-blue)!important}.hover\:bg-blue-700:hover{background-color:#142c54!important}.bg-blue-100{background-color:var(--light-blue)!important}.text-red-700{color:var(--dark-maroon)!important}.bg-red-600{background-color:var(--dark-maroon)!important}.bg-red-100{background-color:rgba(165,35,38,.1)!important}.text-yellow-700{color:var(--orange-yellow)!important}.bg-yellow-100{background-color:rgba(248,181,44,.1)!important}.text-green-700{color:var(--dark-green)!important}.bg-green-600{background-color:var(--dark-green)!important}.bg-green-100{background-color:rgba(16,106,63,.15)!important}.text-purple-700{color:var(--light-purple)!important}.bg-purple-100{background-color:rgba(173,145,195,.2)!important}@keyframes pulse-red{0%{box-shadow:0 0 0 0 rgba(220,38,38,.6)}100%{box-shadow:0 0 10px 5px #dc262600}}.overdue-glow{animation:pulse-red 1.5s infinite;border-color:rgba(220,38,38,.8)}.stat-card-icon{transition:transform .3s ease}.stat-card:hover .stat-card-icon{transform:scale(1.2) rotate(-5deg)}.birthday-container{position:relative;overflow:hidden}.birthday-hat{position:absolute;top:-10px;left:50%;width:18px;height:18px;clip-path:polygon(50% 0,0 100%,100% 100%);background:repeating-linear-gradient(135deg,#f8b52c 0,#f8b52c 4px,#ffd166 4px,#ffd166 8px);transform-origin:bottom center;animation:hat-bounce 1.5s infinite;z-index:10;pointer-events:none}.birthday-hat::before{content:'';position:absolute;top:-5px;left:calc(50% - 4px);width:8px;height:8px;background:#f15bb5;border-radius:50%}.birthday-hat::after{content:'';position:absolute;bottom:-3px;left:-2px;width:22px;height:4px;background:#fff;border-radius:2px}@keyframes hat-bounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-3px)}}@keyframes confetti-fall{0%{transform:translateY(-100%) rotate(0);opacity:1}100%{transform:translateY(200%) rotate(360deg);opacity:0}}.confetti{position:absolute;width:8px;height:15px;background-color:red;opacity:0;animation:confetti-fall 3s linear infinite;pointer-events:none}.confetti:nth-child(1){left:10%;animation-delay:0s;background-color:#f8b52c}.confetti:nth-child(2){left:20%;animation-delay:-.5s;background-color:#106a3f}.confetti:nth-child(3){left:30%;animation-delay:-1s;background-color:#1a3a6e}.confetti:nth-child(4){left:40%;animation-delay:-1.5s;background-color:#a52326}.confetti:nth-child(5){left:50%;animation-delay:-2s;background-color:#ad91c3}.confetti:nth-child(6){left:60%;animation-delay:-2.5s;background-color:#f8b52c}.confetti:nth-child(7){left:70%;animation-delay:-3s;background-color:#106a3f}.confetti:nth-child(8){left:80%;animation-delay:-3.5s;background-color:#1a3a6e}.confetti:nth-child(9){left:90%;animation-delay:-4s;background-color:#a52326}</style></head><body class="bg-gray-100 min-h-screen"><div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex flex-col items-center justify-center hidden z-50"><i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i><p class="mt-4 text-lg text-gray-700 font-medium">æ­£åœ¨è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š...</p></div><div id="errorDisplay" class="hidden fixed inset-x-0 top-0 p-4 z-50"><div class="max-w-2xl mx-auto bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-r-lg shadow-lg" role="alert"><p class="font-bold">è³‡æ–™è¼‰å…¥å¤±æ•—</p><p id="errorMessage">ç„¡æ³•å¾ä¼ºæœå™¨ç²å–å°ˆæ¡ˆæ•¸æ“šï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</p></div></div><div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center text-slate-900 mb-6">ç®¡ç†è€…ç™»å…¥</h2><div id="login-message" class="text-center mb-4 font-medium h-auto min-h-[1.5rem] text-red-500"></div><form id="loginForm"><div class="mb-4"><label for="username" class="block text-slate-700 mb-2">äººäº‹è™Ÿ</label><input type="text" id="username" name="username" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="mb-4 relative"><label for="password" class="block text-slate-700 mb-2">å¯†ç¢¼</label><input type="password" id="password" name="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required><span id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 pt-7 cursor-pointer"><i class="fa fa-eye-slash text-gray-400" aria-hidden="true"></i></span></div><div class="flex items-center justify-between gap-4 mt-6"><button type="button" id="closeModalBtn" class="w-full bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors duration-300">é—œé–‰</button><button type="submit" id="loginSubmitBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center"><span class="btn-text">ç™»å…¥</span><i class="fas fa-spinner fa-spin ml-2 hidden btn-spinner"></i></button></div></form><div class="text-center mt-4"><button id="openChangePasswordModalBtn" class="text-sm text-blue-600 hover:underline">æ›´æ›å¯†ç¢¼</button></div></div></div><div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm"><h2 class="text-2xl font-bold text-center text-slate-900 mb-6">æ›´æ›å¯†ç¢¼</h2><div id="change-password-message" class="text-center mb-4 font-medium h-6"></div><form id="changePasswordForm"><div class="mb-4"><label for="cp-employeeId" class="block text-slate-700 mb-2">äººäº‹è™Ÿ</label><input type="text" id="cp-employeeId" name="employeeId" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="mb-4"><label for="cp-oldPassword" class="block text-slate-700 mb-2">èˆŠå¯†ç¢¼</label><input type="password" id="cp-oldPassword" name="oldPassword" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="mb-6"><label for="cp-newPassword" class="block text-slate-700 mb-2">æ–°å¯†ç¢¼</label><input type="password" id="cp-newPassword" name="newPassword" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="flex items-center justify-between gap-4"><button type="button" id="closeChangePasswordModalBtn" class="w-full bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors duration-300">è¿”å›ç™»å…¥</button><button type="submit" id="changePasswordSubmitBtn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center"><span class="btn-text">ç¢ºèªæ›´æ›</span><i class="fas fa-spinner fa-spin ml-2 hidden btn-spinner"></i></button></div></form></div></div><div id="aiModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-brain text-blue-500 mr-3"></i>AI åˆ¤è®€èˆ‡æ±ºç­–å»ºè­°</h2><button id="closeAiModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div id="ai-suggestion-content" class="overflow-y-auto text-gray-700 leading-relaxed ai-content"></div></div></div><div id="activityModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-calendar-alt text-purple-500 mr-3"></i>æ´»å‹•æ¦‚è¦½</h2><button id="closeActivityModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div id="activity-content" class="overflow-y-auto text-gray-700 leading-relaxed activity-content"></div></div></div><div id="weeklySummaryModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg flex flex-col"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-clipboard-list text-green-500 mr-3"></i>æœ¬é€±é‡é»</h2><button id="closeWeeklySummaryBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div id="weekly-summary-content" class="overflow-y-auto text-gray-700 leading-relaxed space-y-2"></div></div></div><div id="itemListModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden p-4"><div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg flex flex-col"><div class="flex justify-between items-center border-b pb-3 mb-4"><h2 id="itemListModalTitle" class="text-xl font-bold text-gray-800 flex items-center"></h2><button id="closeItemListModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div id="itemListModalContent" class="overflow-y-auto max-h-[60vh] text-gray-700 leading-relaxed space-y-2"></div></div></div><header class="bg-white shadow-md border-b-2 border-gray-200"><div class="max-w-7xl mx-auto px-4 sm:px-6 py-4"><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4"><div class="text-center sm:text-left"><h1 class="text-3xl font-black text-gray-900 tracking-wider">æ•™å­¸éƒ¨-å°ˆæ¡ˆå„€è¡¨æ¿</h1><p class="text-sm text-gray-500 mt-1">å³æ™‚è¿½è¹¤æ‰€æœ‰é€²è¡Œä¸­çš„å°ˆæ¡ˆèˆ‡ä»»å‹™</p></div><div class="flex flex-wrap items-center justify-center sm:justify-end gap-2 sm:gap-4"><div class="relative"><input type="search" id="searchInput" oninput="filterBySearch(this.value)" placeholder="æœå°‹é …ç›®..." class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-1.5 pl-8"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i class="fas fa-search text-gray-400"></i></div></div><select id="yearFilter" onchange="filterByYear(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5"></select><select id="monthFilter" onchange="filterByMonth(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5"></select><button id="aiBtn" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-lg text-sm transition-transform hover:scale-105 flex items-center shadow-lg"><i class="fas fa-brain mr-2"></i>AI æ±ºç­–å»ºè­°</button><button id="loginBtn" class="bg-slate-800 text-white font-semibold px-4 py-2 rounded-lg text-sm transition-transform hover:scale-105 shadow-lg">ç®¡ç†è€…ç™»å…¥</button></div></div></div></header><div class="bg-white shadow-sm sticky top-0 z-40"><div class="container mx-auto px-4 sm:px-6 border-b"><div id="unitTabs" class="flex flex-wrap justify-center space-x-2 py-3"></div></div><div class="container mx-auto px-4 sm:px-6"><div id="groupTabs" class="flex flex-wrap justify-center space-x-2 py-3"></div></div></div><main class="max-w-7xl mx-auto px-4 sm:px-6 py-8"><div class="grid grid-cols-1 lg:grid-cols-4 gap-8"><div class="lg:col-span-1"><div class="bg-white rounded-xl shadow-lg border border-gray-100 h-full"><div class="p-6 border-b-2 border-gray-100 bg-gradient-to-r from-blue-900 to-blue-600 rounded-t-xl"><h3 class="text-xl font-bold text-white flex items-center gap-3"><i class="fas fa-users-cog"></i>æ•™å­¸éƒ¨æˆ°éšŠæˆå“¡</h3></div><div class="p-4"><div id="teamMembers" class="space-y-2"></div></div></div></div><div class="lg:col-span-3 space-y-8"><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6"><div onclick="showItemsInModal('total')" class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-blue-500 transition-all hover:shadow-2xl hover:-translate-y-1 cursor-pointer"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-600" title="å°ˆæ¡ˆ/ä»»å‹™">ç¸½é …ç›®æ•¸</p><p class="text-3xl font-bold text-gray-900" id="totalTasks">0</p></div><div class="text-blue-500 text-4xl stat-card-icon"><i class="fas fa-dragon"></i></div></div></div><div onclick="showItemsInModal('active')" class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-purple-500 transition-all hover:shadow-2xl hover:-translate-y-1 cursor-pointer"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-600">é€²è¡Œä¸­</p><p class="text-3xl font-bold text-purple-700" id="activeTasks">0</p></div><div class="text-purple-500 text-4xl stat-card-icon"><i class="fas fa-rocket"></i></div></div></div><div onclick="showItemsInModal('overdue')" class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-red-500 transition-all hover:shadow-2xl hover:-translate-y-1 cursor-pointer"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-600">é€¾æœŸé …ç›®</p><p class="text-3xl font-bold text-red-700" id="overdueTasks">0</p></div><div class="text-red-500 text-4xl stat-card-icon"><i class="fas fa-skull-crossbones"></i></div></div></div><div onclick="showItemsInModal('completed')" class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-green-500 transition-all hover:shadow-2xl hover:-translate-y-1 cursor-pointer"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-600">å·²å®Œæˆ</p><p class="text-3xl font-bold text-green-700" id="completedTasks">0</p></div><div class="text-green-500 text-4xl stat-card-icon"><i class="fas fa-trophy"></i></div></div></div><div onclick="openActivityModal()" class="stat-card bg-white rounded-xl shadow-lg p-5 border-l-4 border-yellow-500 cursor-pointer transition-all hover:shadow-2xl hover:-translate-y-1"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-600">æ´»å‹•ç¸½æ•¸</p><p class="text-3xl font-bold text-yellow-700" id="activityCount">0</p></div><div class="text-yellow-500 text-4xl stat-card-icon"><i class="fas fa-calendar-check"></i></div></div></div></div><div class="bg-white rounded-xl shadow-lg border border-gray-100"><div class="p-6 border-b border-gray-100"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><h2 class="text-2xl font-bold text-gray-900 flex-shrink-0">é …ç›®æ¦‚è¦½</h2><div class="flex flex-wrap gap-2 justify-start sm:justify-end"><button onclick="filterItemsByStatus('all', event)" class="filter-btn active px-3 py-1 text-sm rounded-lg bg-blue-100 text-blue-700 transition-all">å…¨éƒ¨</button><button onclick="filterItemsByStatus('planning', event)" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-700 transition-all">è¦åŠƒä¸­</button><button onclick="filterItemsByStatus('active', event)" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-700 transition-all">é€²è¡Œä¸­</button><button onclick="filterItemsByStatus('completed', event)" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-700 transition-all">å·²å®Œæˆ</button><button onclick="filterItemsByStatus('overdue', event)" class="filter-btn px-3 py-1 text-sm rounded-lg bg-gray-100 text-gray-700 transition-all">é€¾æœŸ</button></div></div></div><div class="p-6"><div id="itemsList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div></div></div></div></div></main><button id="scrollToTopBtn" title="å›åˆ°é ‚éƒ¨" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all z-50 hover:scale-110"><i class="fas fa-arrow-up"></i></button><button id="openChatBot" title="è©¢å•æ¦‚æ³" class="hidden fixed bottom-5 right-20 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 focus:outline-none z-50 transition-all hover:scale-110"><i class="fas fa-robot"></i></button><div id="chatBotContainer" class="hidden fixed bottom-20 right-5 w-96 bg-white border border-gray-200 rounded-xl shadow-lg flex flex-col z-50"><div class="flex justify-between items-center bg-indigo-600 text-white px-4 py-2 rounded-t-xl"><span class="font-semibold">æˆ°éšŠå°å¹«æ‰‹</span><button id="closeChatBot" class="text-white text-xl leading-none">&times;</button></div><div id="chatBotMessages" class="p-4 space-y-2 text-sm overflow-y-auto max-h-[60vh]"></div></div><script>const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzvl5lYY1LssljDNJJyGuAGsLd3D0sbGSs4QTZxgz2PAZJ38EpsHzEk740LGiQ5AMok/exec",localProfileImages={ç›§è‹±äº‘:"ç›§è‹±äº‘.png",é™³è©©èŠ¸:"é™³è©©èŠ¸.jpg",æ¥Šå®œå©·:"æ¥Šå®œå©·.png",é»ƒæƒ æ´¥:"é»ƒæƒ æ´¥.png",ç‹å¬¿èŒ¹:"ç‹å¬¿èŒ¹.png",ä¾¯æ˜±ç‘¾:"ä¾¯æ˜±ç‘¾.png",å»–å®¶å¾·:"å»–å®¶å¾·.png"},groupData={"teaching-center":"æ•™å­¸ä¸­å¿ƒ",fdc:"æ•™å¸«åŸ¹è‚²ä¸­å¿ƒ",resident:"ä½é™¢é†«å¸«è¨“ç·´å°çµ„",clerk:"å¯¦ç¿’é†«å­¸ç”Ÿè¨“ç·´å°çµ„",pgy:"PGYè¨“ç·´çµ„",csc:"è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒ","allied-health":"é†«äº‹äººå“¡è¨“ç·´å°çµ„","chart-review":"ç—…æ­·å¯©æŸ¥å°çµ„"};let allActivities=[],staffData=[],currentUnitFilter="all",currentGroupFilter="all",currentStatusFilter="all",currentMemberFilter="all",currentYearFilter="all",currentMonthFilter="all",currentSearchTerm="",calendarDate=new Date;const sanitizeHTML=e=>{if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML},getStatusColor=e=>({completed:"bg-green-500",active:"bg-purple-500",overdue:"bg-red-500",planning:"bg-yellow-500"}[e]||"bg-gray-500"),getStatusText=e=>({completed:"å·²å®Œæˆ",active:"é€²è¡Œä¸­",overdue:"é€¾æœŸ",planning:"è¦åŠƒä¸­"}[e]||"æœªçŸ¥"),formatDate=e=>e?new Date(e).toLocaleDateString("zh-TW"):"",getTypeText=e=>({project:"å°ˆæ¡ˆ",task:"ä»»å‹™",activity:"æ´»å‹•",meeting:"æœƒè­°"}[e]||"é …ç›®"),getTypeStyle=(e,t)=>{switch(e){case"project":return"text-blue-700";case"task":return"text-green-700";case"activity":return"text-purple-700";case"meeting":return"completed"===t?"text-gray-400":"text-indigo-700";default:return"text-gray-500"}};async function fetchStaffData(){try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"getAllUsers"}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!e.ok)throw new Error("ç„¡æ³•ç²å–åœ˜éšŠæˆå“¡è³‡æ–™");const t=await e.json();if("success"!==t.status)throw new Error(t.message);staffData=t.data.map(e=>({id:e.employeeId,name:e.name,group:e.group,birthday:e.birthday,unit:e.unit}))}catch(e){throw console.error("ç²å–åœ˜éšŠæˆå“¡è³‡æ–™å¤±æ•—:",e),e}}async function fetchAllItems(){try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"getAllItems"}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!e.ok)throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${e.statusText}`);const t=await e.json();if("success"!==t.status)throw new Error(t.message);const a=new Date;a.setHours(0,0,0,0),allActivities=t.data.map(e=>{const t=parseInt(e.progress,10)||0,s=e.deadline?new Date(e.deadline):null;let i=e.status||"planning";return t>=100?i="completed":"completed"!==i&&s&&s<a&&(i="overdue"),{...e,progress:t,status:i,lastWeekProgress:e.lastWeekProgress?parseInt(e.lastWeekProgress,10):0,helpMessage:e.helpMessage||"",checklist:Array.isArray(e.checklist)?e.checklist:[]}})}catch(e){throw console.error("ç²å–æ‰€æœ‰é …ç›®å¤±æ•—:",e),e}}function renderUnitTabs(){if(!staffData||0===staffData.length)return;const e=document.getElementById("unitTabs"),t=["all",...new Set(staffData.map(e=>e.unit).filter(Boolean))];e.innerHTML=t.map(e=>{const t="all"===e?"å…¨éƒ¨å–®ä½":e;return`<button onclick="filterByUnit('${e}')" id="tab-unit-${e}" class="unit-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===currentUnitFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${t}</button>`}).join("")}function renderGroupTabs(e){const t=document.getElementById("groupTabs"),a=[...new Set(e.map(e=>e.group).filter(Boolean))];if(a.length<=1&&"all"!==currentUnitFilter)return t.innerHTML="",void(t.style.padding="0");t.style.padding="0.75rem 0";let s="";a.length>0&&(s+=`<button onclick="filterByGroup('all')" id="tab-all" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${"all"===currentGroupFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">å…¨éƒ¨çµ„åˆ¥</button>`),s+=a.map(e=>{const t=groupData[e]||e;return`<button onclick="filterByGroup('${e}')" id="tab-${e}" class="group-tab-btn px-4 py-2 text-sm rounded-lg font-medium transition-colors mb-2 ${e===currentGroupFilter?"tab-active":"bg-gray-100 hover:bg-gray-200"}">${t}</button>`}).join(""),t.innerHTML=s}function renderYearFilter(){const e=document.getElementById("yearFilter"),t=["all",...new Set(allActivities.map(e=>e.startDate?new Date(e.startDate).getFullYear():null).filter(Boolean))].sort();e.innerHTML=t.map(e=>`<option value="${e}">${"all"===e?"å…¨éƒ¨å¹´ä»½":`${e}å¹´`}</option>`).join(""),e.value=currentYearFilter}function renderMonthFilter(){const e=document.getElementById("monthFilter"),t=["all",1,2,3,4,5,6,7,8,9,10,11,12];e.innerHTML=t.map(e=>`<option value="${e}">${"all"===e?"å…¨éƒ¨æœˆä»½":`${e}æœˆ`}</option>`).join(""),e.value=currentMonthFilter}function renderItems(e){const t=document.getElementById("itemsList");let a=e;"all"!==currentStatusFilter&&(a=e.filter(e=>e.status===currentStatusFilter)),0===a.length?t.innerHTML='<div class="text-center text-gray-400 py-8 col-span-full"><i class="fas fa-folder-open fa-3x mb-4"></i><p class="font-semibold">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é …ç›®</p><p class="text-sm mt-1">è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p></div>':t.innerHTML=a.map(e=>{const t=e.checklist||[],a=t.length,s=t.filter(e=>e.completed).length,i=e.progress-(e.lastWeekProgress||0),r=i>0?`<span class="text-green-600 font-medium text-sm ml-2">â–² ${i}%</span>`:i<0?`<span class="text-red-600 font-medium text-sm ml-2">â–¼ ${Math.abs(i)}%</span>`:"",l=a>0?t.map(e=>`\n                        <li class="flex items-center ${e.completed?"text-emerald-300":"text-gray-400"}">\n                            <span class="w-5 text-left">${e.completed?"âœ“":"â—‹"}</span>\n                            <span>${sanitizeHTML(e.name)}</span>\n                        </li>`).join(""): "<li>ç„¡å®šç¾©çš„æª¢æŸ¥é»</li>";return`\n                <div class="bg-white border rounded-xl p-4 flex flex-col h-full shadow-lg hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 ${"overdue"===e.status?"overdue-glow":"border-gray-200"}">\n                    <div class="flex-grow">\n                        <div class="flex justify-between items-start mb-3">\n                            <div class="flex-1">\n                                <h4 class="font-bold text-lg text-gray-900 mb-1">${sanitizeHTML(e.name)} <span class="text-sm font-medium ${getTypeStyle(e.type,e.status)}">(${getTypeText(e.type)})</span></h4>\n                                ${e.description?`<p class="text-sm text-gray-500 mt-1 mb-2 whitespace-pre-wrap">${sanitizeHTML(e.description)}</p>`:""}\n                                <p class="text-sm text-gray-600">ä¸»è¦è² è²¬: ${sanitizeHTML(e.assignees.join(", "))}</p>\n                                ${e.collaborators&&e.collaborators.length>0?`<p class="text-sm text-gray-600">å”åŠ©: ${sanitizeHTML(e.collaborators.join(", "))}</p>`:""}\n                            </div>\n                            <div class="flex items-center space-x-2 ml-2">\n                                <span class="flex items-center text-sm font-semibold px-2 py-1 rounded-full ${getStatusColor(e.status)} text-white">${getStatusText(e.status)}</span>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="mt-auto border-t border-gray-100 pt-3">\n                        <div class="mb-3">\n                            <div class="flex justify-between items-center text-sm mb-1">\n                                <span class="text-gray-600 font-semibold">é€²åº¦: ${e.progress}%</span>\n                                ${r}\n                            </div>\n                            <div class="w-full bg-gray-200 rounded-full h-2.5">\n                                <div class="progress-bar h-2.5 rounded-full ${getStatusColor(e.status)}" style="width: ${e.progress}%"></div>\n                            </div>\n                            <div class="relative group">\n                                <p class="text-sm text-gray-600 mt-1 cursor-pointer">æª¢æŸ¥é»: ${s}/${a}</p>\n                                <div class="absolute bottom-full mb-2 w-64 p-3 bg-slate-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20">\n                                    <h4 class="font-bold mb-2 border-b border-b-slate-600 pb-1">æ¨™æº–åŒ–æµç¨‹</h4>\n                                    <ul class="space-y-1 mt-2">${l}</ul>\n                                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="flex justify-between items-center text-xs text-gray-500">\n                            <span>æ—¥æœŸ: ${formatDate(e.startDate)} - ${e.deadline?formatDate(e.deadline):"ç„¡"}</span>\n                            ${"overdue"===e.status?'<span class="text-red-600 font-medium">âš ï¸ å·²é€¾æœŸ</span>':""}\n                        </div>\n\n                        ${e.helpMessage?`\n                        <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-100 flex items-start space-x-3">\n                            <span class="text-xl pt-1">ğŸ˜­</span>\n                            <div>\n                                <p class="font-semibold text-red-800 text-sm">éœ€è¦å”åŠ©ï¼š</p>\n                                <p class="text-sm text-red-700 whitespace-pre-wrap">${sanitizeHTML(e.helpMessage)}</p>\n                            </div>\n                        </div>\n                        `:""}\n                    </div>\n                </div>`}).join("")}function renderTeamMembers(e,t){const a=document.getElementById("teamMembers");if(!e||0===e.length)return void(a.innerHTML='<p class="text-center text-gray-500 py-4">æ­¤ç¯©é¸æ¢ä»¶ä¸‹ç„¡æˆå“¡</p>');const s=new Date,i=s.getMonth()+1,r=s.getDate(),l=`${String(i).padStart(2,"0")}/${String(r).padStart(2,"0")}`;a.innerHTML=e.map(e=>{const a=e.name,s=t.filter(e=>e.assignees.includes(a)||(e.collaborators&&e.collaborators.includes(a))),i=s.filter(e=>"overdue"===e.status).length,r=s.filter(e=>"project"===e.type).length,o=s.filter(e=>"task"===e.type).length,n=a===currentMemberFilter,d=e.birthday===l,c=d?"birthday-container":"",u=d?'<div class="birthday-hat"></div>':"",p=d?Array.from({length:9}).map((e,t)=>'<div class="confetti"></div>').join(""): "";return`\n                <div onclick="filterByMember('${a}')" class="group relative ${c} flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-300 ${n?"bg-blue-100 shadow-md":"hover:bg-gray-100 hover:shadow-md hover:scale-105"}">\n                    \n                    <div class="absolute right-full top-1/2 -translate-y-1/2 mr-2 w-48 p-4 bg-white rounded-lg shadow-xl opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-300 z-30">\n                        <img src="${localProfileImages[a]?localProfileImages[a]:`https://placehold.co/100x100/93c5fd/ffffff?text=${a.charAt(0)}`}" alt="${a}" class="w-24 h-24 rounded-full mx-auto mb-3 border-4 border-blue-300 object-cover shadow-md" onerror="this.src='https://placehold.co/100x100/93c5fd/ffffff?text=${a.charAt(0)}'; this.onerror=null;">\n                        <p class="font-bold text-center text-gray-900 text-lg">${sanitizeHTML(a)}</p>\n                        <a href="#" onclick="viewMemberHistory('${a}', event)" class="block w-full text-center bg-blue-600 text-white font-semibold py-1.5 rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm mt-3">æª¢è¦–å€‹äººæ­·ç¨‹</a>\n                        <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-white"></div>\n                    </div>\n\n                    ${p}\n                    <div class="flex items-center min-w-0">\n                        <div class="relative flex-shrink-0">\n                            ${u}\n                            ${localProfileImages[a]?`<img src="${localProfileImages[a]}" alt="${a}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.replaceWith(this.parentElement.querySelector('.initial-avatar'))" />`:`<div class="w-10 h-10 bg-sky-500 rounded-full flex items-center justify-center text-white font-semibold initial-avatar">${a.charAt(0)}</div>`}\n                        </div>\n                        <div class="ml-3 min-w-0">\n                            <p class="font-medium text-gray-900 truncate">${sanitizeHTML(a)}</p>\n                            <div class="text-xs text-gray-500 mt-1 flex flex-wrap gap-x-2 gap-y-1">\n                                <span>å°ˆæ¡ˆ: ${r}</span>\n                                <span>ä»»å‹™: ${o}</span>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="text-right flex-shrink-0 ml-2">\n                        ${i>0?`<span class="text-xs font-bold text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center">${i}</span>`:""}\n                    </div>\n                </div>`}).join("")}function updateStats(e){const t=allActivities.filter(e=>"project"===e.type||"task"===e.type),a=allActivities.filter(e=>"activity"===e.type||"meeting"===e.type);document.getElementById("totalTasks").textContent=t.length,document.getElementById("activeTasks").textContent=t.filter(e=>"active"===e.status).length,document.getElementById("overdueTasks").textContent=t.filter(e=>"overdue"===e.status).length,document.getElementById("completedTasks").textContent=allActivities.filter(e=>"completed"===e.status).length,document.getElementById("activityCount").textContent=a.length}function renderDashboard(){let e=allActivities;"all"!==currentYearFilter&&(e=allActivities.filter(e=>e.startDate&&new Date(e.startDate).getFullYear()==currentYearFilter));let t=e;"all"!==currentMonthFilter&&(t=e.filter(e=>e.startDate&&new Date(e.startDate).getMonth()+1==currentMonthFilter));let a=staffData;"all"!==currentUnitFilter&&(a=staffData.filter(e=>e.unit===currentUnitFilter)),renderGroupTabs(a);const s="all"===currentGroupFilter?a:a.filter(e=>e.group===currentGroupFilter),i=s.map(e=>e.name);let r=t.filter(e=>e.assignees.some(e=>i.includes(e))||e.collaborators&&e.collaborators.some(e=>i.includes(e)));if(currentSearchTerm){const e=currentSearchTerm.toLowerCase();r=r.filter(t=>t.name.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e))}let l=r;"all"!==currentMemberFilter&&(l=r.filter(e=>e.assignees.includes(currentMemberFilter)||e.collaborators&&e.collaborators.includes(currentMemberFilter))),l.sort((e,t)=>new Date(e.startDate)-new Date(t.startDate)),updateStats(allActivities),renderTeamMembers(s,t),renderItems(l.filter(e=>"project"===e.type||"task"===e.type))}function filterByUnit(e){currentUnitFilter=e,currentGroupFilter="all",currentMemberFilter="all",document.querySelectorAll(".unit-tab-btn").forEach(t=>{t.classList.toggle("tab-active",t.id===`tab-unit-${e.replace(/\s/g,"-")}`),t.classList.toggle("bg-gray-100",t.id!==`tab-unit-${e.replace(/\s/g,"-")}`),t.classList.toggle("hover:bg-gray-200",t.id!==`tab-unit-${e.replace(/\s/g,"-")}`)}),renderDashboard()}function filterBySearch(e){currentSearchTerm=e,renderDashboard()}function filterByYear(e){currentYearFilter=e,renderDashboard()}function filterByMonth(e){currentMonthFilter=e,renderDashboard()}function filterByGroup(e){currentGroupFilter=e,currentMemberFilter="all",document.querySelectorAll(".group-tab-btn").forEach(t=>{t.classList.toggle("tab-active",t.id===`tab-${e}`)}),renderDashboard()}function filterByMember(e){currentMemberFilter=currentMemberFilter===e?"all":e,renderDashboard()}function filterItemsByStatus(e,t){currentStatusFilter=e;const a={all:["bg-blue-100","text-blue-700"],planning:["bg-yellow-100","text-yellow-700"],active:["bg-purple-100","text-purple-700"],completed:["bg-green-100","text-green-700"],overdue:["bg-red-100","text-red-700"]};document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active",...Object.values(a).flat()),e.classList.add("bg-gray-100","text-gray-700")}),t.target.classList.add("active",...a[e]),t.target.classList.remove("bg-gray-100","text-gray-700"),renderDashboard()}function setupLoginModal(){const e=document.getElementById("loginBtn"),t=document.getElementById("loginModal"),a=document.getElementById("closeModalBtn"),s=document.getElementById("loginForm"),i=document.getElementById("login-message"),r=document.getElementById("loginSubmitBtn"),l=r.querySelector(".btn-text"),o=r.querySelector(".btn-spinner"),n=document.getElementById("togglePassword"),d=document.getElementById("password"),c=document.getElementById("openChangePasswordModalBtn");n.addEventListener("click",function(){const e="password"===d.getAttribute("type")?"text":"password";d.setAttribute("type",e),this.querySelector("i").classList.toggle("fa-eye"),this.querySelector("i").classList.toggle("fa-eye-slash")}),c.addEventListener("click",()=>{t.classList.add("hidden"),document.getElementById("changePasswordModal").classList.remove("hidden")}),e.addEventListener("click",()=>{i.textContent="",s.reset(),t.classList.remove("hidden")}),a.addEventListener("click",()=>t.classList.add("hidden")),t.addEventListener("click",e=>{e.target===t&&t.classList.add("hidden")}),s.addEventListener("submit",async e=>{e.preventDefault();const a=e.target.username.value,n=e.target.password.value;i.textContent="",l.textContent="ç™»å…¥ä¸­...",o.classList.remove("hidden"),r.disabled=!0;try{const e=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"login",username:a,password:n}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!e.ok)throw new Error(`ç¶²è·¯å›æ‡‰éŒ¯èª¤: ${e.status} ${e.statusText}`);const t=await e.json();if("success"===t.status&&t.data.employeeId){const e=t.data;i.textContent="ç™»å…¥æˆåŠŸï¼å³å°‡è·³è½‰...",i.className="text-center mb-4 font-medium text-green-500",setTimeout(()=>{window.location.href=`https://luyun1224.github.io/cmh4200/Project-admin.html?user=${encodeURIComponent(e.name)}&id=${e.employeeId}`},1500)}else throw new Error(t.message||"å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚")}catch(e){console.error("Login Error Details:",e),i.textContent=e.message,i.className="text-center mb-4 font-medium text-red-500"}finally{l.textContent="ç™»å…¥",o.classList.add("hidden"),r.disabled=!1}})}function setupChangePasswordModal(){const e=document.getElementById("changePasswordModal"),t=document.getElementById("changePasswordForm"),a=document.getElementById("change-password-message"),s=document.getElementById("changePasswordSubmitBtn"),i=document.getElementById("closeChangePasswordModalBtn");i.addEventListener("click",()=>{e.classList.add("hidden"),document.getElementById("loginModal").classList.remove("hidden")}),t.addEventListener("submit",async i=>{i.preventDefault();const r=t.elements.employeeId.value,l=t.elements.oldPassword.value,o=t.elements.newPassword.value;a.textContent="",s.disabled=!0,s.querySelector(".btn-text").textContent="è™•ç†ä¸­...",s.querySelector(".btn-spinner").classList.remove("hidden");try{const t=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",body:JSON.stringify({action:"updatePassword",employeeId:r,oldPassword:l,newPassword:o}),headers:{"Content-Type":"text/plain;charset=utf-8"}});if(!t.ok)throw new Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");const i=await t.json();if("success"===i.status)a.textContent="å¯†ç¢¼æ›´æ–°æˆåŠŸï¼",a.className="text-center mb-4 font-medium text-green-500",e.querySelector("form").reset();else throw new Error(i.message||"æ›´æ–°å¤±æ•—")}catch(e){a.textContent=e.message,a.className="text-center mb-4 font-medium text-red-500"}finally{s.disabled=!1,s.querySelector(".btn-text").textContent="ç¢ºèªæ›´æ›",s.querySelector(".btn-spinner").classList.add("hidden")}})}function openActivityModal(e=!0){e&&(calendarDate=new Date);const t=document.getElementById("activityModal"),a=document.getElementById("activity-content"),s=new Date;s.setHours(0,0,0,0);const i=allActivities.filter(e=>{const t=e.type&&(e.type.toLowerCase()==="activity"||e.type.toLowerCase()==="meeting");return t}),r=generateCalendarHTML(calendarDate.getFullYear(),calendarDate.getMonth(),i);if(0===i.length)return a.innerHTML=r+'<p class="text-center text-gray-500 mt-4">ç›®å‰æ²’æœ‰ä»»ä½•æ´»å‹•ã€‚</p>',void t.classList.remove("hidden");const l=i.slice().sort((e,t)=>{const a=new Date(e.startDate),i=new Date(t.startDate),r=(e.deadline?new Date(e.deadline):a)<s,l=(t.deadline?new Date(t.deadline):i)<s;return r!==l?r?1:-1:a-i}),o=e=>{if(0===e.length)return'<p class="text-center text-gray-500 mt-4">æ­¤æœˆä»½æ²’æœ‰æ´»å‹•åˆ—è¡¨ã€‚</p>';let t="";let a="";return e.forEach(e=>{const i=new Date(e.startDate),r=`${i.getFullYear()}-${i.getMonth()+1}`;if(r!==a){a&&(t+="</ul></div>"),a=r,t+=`<div class="mt-4"><h3 class="text-2xl font-bold text-purple-700 mb-2">${i.getFullYear()}å¹´${i.getMonth()+1}æœˆ</h3><ul class="space-y-4">`}const l=i.getDate(),o=e.deadline&&e.deadline!==e.startDate?` - ${formatDate(e.deadline)}`:"",n=(e.deadline?new Date(e.startDate):new Date(e.startDate))<s;t+=`<li class="relative flex items-start space-x-4 p-2 rounded-lg ${n?"bg-gray-100":"hover:bg-gray-50"}">\n                                ${n?'<span class="absolute top-1 right-1 text-xs bg-gray-200 text-gray-600 px-1 rounded">å·²éæœŸ</span>':""}\n                                <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-purple-100 rounded-lg">\n                                <span class="text-xl font-bold text-purple-700">${l}</span>\n                                </div>\n                                <div class="flex-grow pt-1">\n                                <p class="font-semibold text-gray-800">${sanitizeHTML(e.name)}</p>\n                                <p class="text-sm text-gray-600">æ—¥æœŸ: ${formatDate(e.startDate)}${o}</p>\n                                <p class="text-sm text-gray-500">è² è²¬äºº: ${sanitizeHTML(e.assignees.join(", "))}</p>\n                                ${e.collaborators&&e.collaborators.length>0?`<p class="text-sm text-gray-500">å”åŠ©: ${sanitizeHTML(e.collaborators.join(", "))}</p>`:""}\n                                </div>\n                                </li>`}),a&&(t+="</ul></div>"),t};a.innerHTML=r+'<hr class="my-6"/>'+`<div class="space-y-6">${o(l)}</div>`,t.classList.remove("hidden")}function showItemsInModal(e){const t=document.getElementById("itemListModal"),a=document.getElementById("itemListModalTitle"),s=document.getElementById("itemListModalContent");let i=[],r="";const l=allActivities.filter(e=>"project"===e.type||"task"===e.type),o={active:1,planning:2,overdue:3,completed:4};switch(e){case"total":i=l.sort((e,t)=>(o[e.status]||99)-(o[t.status]||99)),r="ç¸½é …ç›®åˆ—è¡¨";break;case"active":i=l.filter(e=>"active"===e.status),r="é€²è¡Œä¸­é …ç›®åˆ—è¡¨";break;case"overdue":i=l.filter(e=>"overdue"===e.status),r="é€¾æœŸé …ç›®åˆ—è¡¨";break;case"completed":i=allActivities.filter(e=>"completed"===e.status),r="å·²å®Œæˆé …ç›®åˆ—è¡¨"}a.innerHTML=`<i class="fas fa-list-check mr-3"></i> ${r} (${i.length})`,s.innerHTML=0===i.length?'<p class="text-center text-gray-500 py-4">æ­¤é¡åˆ¥ä¸­æ²’æœ‰é …ç›®ã€‚</p>':i.map(e=>`\n                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100">\n                        <p class="font-semibold text-gray-800">${sanitizeHTML(e.name)}</p>\n                        <p class="text-sm text-gray-600">è² è²¬äºº: ${sanitizeHTML(e.assignees.join(", "))}</p>\n                        <div class="flex justify-between items-center text-xs mt-1">\n                            <span class="font-medium ${getTypeStyle(e.type,e.status)}">(${getTypeText(e.type)})</span>\n                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${getStatusColor(e.status)} text-white">${getStatusText(e.status)}</span>\n                        </div>\n                    </div>\n                `).join(""),t.classList.remove("hidden")}async function getAiSuggestions(){const e=document.getElementById("ai-suggestion-content");e.innerHTML='\n                <div class="flex flex-col items-center justify-center p-8">\n                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i>\n                    <p class="mt-4 text-gray-600 font-medium">AI æ­£åœ¨åˆ†ææ•¸æ“šä¸¦ç”¢ç”Ÿæ±ºç­–æ‘˜è¦ï¼Œè«‹ç¨å€™...</p>\n                </div>';const t=allActivities.filter(e=>["project","task"].includes(e.type)),a=t.length,s=t.filter(e=>"overdue"===e.status),i=t.filter(e=>"active"===e.status),r=t.filter(e=>"planning"===e.status),l=t.filter(e=>"completed"===e.status),o=i.filter(e=>e.progress<30),n=i.filter(e=>e.progress-(e.lastWeekProgress||0)==0),d={};s.forEach(e=>{e.assignees.forEach(e=>{d[e]||(d[e]={overdue:0,active:0}),d[e].overdue++})}),i.forEach(e=>{e.assignees.forEach(e=>{d[e]||(d[e]={overdue:0,active:0}),d[e].active++})});const c=Object.entries(d).filter(([e,t])=>t.overdue>1||t.overdue>0&&t.active>2).map(([e,t])`${e} (è² è²¬ ${t.overdue} é …é€¾æœŸ, ${t.active} é …é€²è¡Œä¸­)`),u=`\n                ä½ æ˜¯ä¸€ä½é ‚å°–çš„å°ˆæ¡ˆç®¡ç†é¡§å•ï¼Œè«‹ç‚ºä¸€ä½é«˜éšç¶“ç†äººæ’°å¯«ä¸€ä»½æ±ºç­–æ‘˜è¦ã€‚\n                è«‹æ ¹æ“šæˆ‘æä¾›çš„ **çœŸå¯¦æ•¸æ“š**ï¼Œç”Ÿæˆä¸€å€‹ JSON ç‰©ä»¶ï¼Œå…§å®¹å¿…é ˆåæ˜ é€™äº›æ•¸æ“šã€‚\n\n                **ç•¶å‰å°ˆæ¡ˆæ•¸æ“šæ‘˜è¦:**\n                - **ç¸½é …ç›®æ•¸:** ${a}\n                - **ç‡ˆè™Ÿåˆ†æ (RAG):**\n                    - ç´…ç‡ˆ (é€¾æœŸ): ${s.length} é …\n                    - é»ƒç‡ˆ (é€²è¡Œä¸­): ${i.length} é …\n                    - è—ç‡ˆ (è¦åŠƒä¸­): ${r.length} é …\n                    - ç¶ ç‡ˆ (å·²å®Œæˆ): ${l.length} é …\n                - **éœ€ç«‹å³é—œæ³¨çš„é€¾æœŸé …ç›®:** ${s.length>0?s.map(e=>`"${e.name}" (è² è²¬äºº: ${e.assignees.join(", ")})`).join("; "):"ç„¡"}\n                - **é€²åº¦åš´é‡è½å¾Œçš„é …ç›® (<30%):** ${o.length>0?o.map(e=>`"${e.name}" (é€²åº¦${e.progress}%, è² è²¬äºº: ${e.assignees.join(", ")})`).join("; "):"ç„¡"}\n                - **å¯èƒ½åœæ»¯çš„é …ç›® (ä¸€é€±å…§ç„¡é€²å±•):** ${n.length>0?n.map(e=>`"${e.name}" (è² è²¬äºº: ${e.assignees.join(", ")})`).join("; "):"ç„¡"}\n                - **æ½›åœ¨éå‹æˆå“¡ (éœ€é—œæ³¨):** ${c.length>0?c.join("; "):"ç„¡"}\n\n                è«‹åŸºæ–¼ä»¥ä¸Šæ•¸æ“šï¼Œå¡«å……ä»¥ä¸‹ JSON çµæ§‹ï¼Œæä¾›å…·é«”ã€å¯åŸ·è¡Œçš„åˆ†æèˆ‡å»ºè­°ã€‚\n            `,p={contents:[{role:"user",parts:[{text:u}]}],generationConfig:{responseMimeType:"application/json",responseSchema:{type:"OBJECT",properties:{healthOverview:{type:"OBJECT",properties:{summary:{type:"STRING",description:"åŸºæ–¼æ•¸æ“šï¼Œç”¨1-2å¥è©±ç¸½çµç›®å‰å°ˆæ¡ˆçµ„åˆçš„æ•´é«”å¥åº·åº¦ã€‚"},rag:{type:"ARRAY",items:{type:"STRING"},description:"æ¢åˆ—å‡ºæ•¸æ“šä¸­ç´…ã€é»ƒã€è—ã€ç¶ å››å€‹ç‡ˆè™Ÿçš„é …ç›®æ•¸é‡èˆ‡ç°¡è¦èªªæ˜ã€‚"}}},riskAssessment:{type:"ARRAY",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"é¢¨éšªæ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'å·²é€¾æœŸå°ˆæ¡ˆ (ç«‹å³è™•ç†)'ã€'é€²åº¦è½å¾Œè­¦ç¤º'ã€'è³‡æºç“¶é ¸é¢¨éšª'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"æ ¹æ“šæ•¸æ“šï¼Œåˆ—å‡ºè©²é¢¨éšªä¸‹çš„å…·é«”é …ç›®æˆ–äººå“¡ã€‚"}}}},recommendations:{type:"ARRAY",items:{type:"OBJECT",properties:{title:{type:"STRING",description:"å»ºè­°æ¬¡æ¨™é¡Œï¼Œä¾‹å¦‚ 'å¬é–‹ç·Šæ€¥æœƒè­°'ã€'é‡æ–°åˆ†é…è³‡æº'ã€'å»ºç«‹é€²åº¦å›å ±æ©Ÿåˆ¶'ã€‚"},points:{type:"ARRAY",items:{type:"STRING"},description:"é‡å°é¢¨éšªè©•ä¼°ä¸­çš„å•é¡Œï¼Œæå‡ºå…·é«”ã€å¯æ“ä½œçš„å»ºè­°ã€‚"}}}}}}}};try{const t=await fetch(SCRIPT_URL,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"getAiSuggestionProxy",payload:p})});if(!t.ok){const e=await t.json().catch(()=>({message:t.statusText}));throw new Error(`ä»£ç†ä¼ºæœå™¨è«‹æ±‚å¤±æ•—: ${e.message||t.statusText}`)}const a=await t.json();if(a.candidates&&a.candidates.length>0&&a.candidates[0].content.parts[0].text){const t=a.candidates[0].content.parts[0].text,s=JSON.parse(t);e.innerHTML=renderAiReport(s)}else{if(a.error)throw new Error(`AI API éŒ¯èª¤: ${a.error.message}`);throw new Error("AI æœªèƒ½æä¾›æœ‰æ•ˆçš„å»ºè­°ã€‚å›æ‡‰ç‚ºç©ºæˆ–æ ¼å¼ä¸ç¬¦ã€‚")}}catch(t){console.error("AI Suggestion Error:",t),e.innerHTML=`\n                    <div class="p-4 bg-red-100 text-red-700 rounded-lg">\n                        <p class="font-bold">ç„¡æ³•ç²å– AI å»ºè­°</p>\n                        <p>${t.message}</p>\n                    </div>`}}function renderAiReport(e){const{healthOverview:t={},riskAssessment:a=[],recommendations:s=[]}=e,i=t.rag||[],r=t.summary||"ç„¡æ³•ç”Ÿæˆç¸½çµã€‚",l=(e,t,a,s)=>`\n                    <div>\n                        <h3 class="text-xl font-bold ${t} flex items-center mb-3"><i class="fas ${a} mr-3 fa-fw"></i>${e}</h3>\n                        <div class="pl-5 space-y-3">${s}</div>\n                    </div>\n                `,o=e=>{if(!Array.isArray(e)||0===e.length)return'<p class="text-sm text-gray-500">ç„¡å…·é«”é …ç›®ã€‚</p>';let t='<ul class="list-none space-y-2">';return t+=e.map(e=>`\n                    <li class="flex items-start">\n                        <span class="mr-3 text-gray-500 mt-1.5 text-xs">â—</span>\n                        <span class="text-gray-800 flex-1 text-sm">${sanitizeHTML(e)}</span>\n                    </li>\n                `).join(""),t+="</ul>"},n=`\n                <p class="pl-8 text-gray-800 text-sm">${sanitizeHTML(r)}</p>\n                ${i.map(e=>{let t="text-gray-600",a="fa-info-circle";return e.includes("ç´…")||e.includes("é€¾æœŸ")?(t="text-red-600",a="fa-exclamation-circle"):e.includes("é»ƒ")||e.includes("é€²è¡Œä¸­")?(t="text-yellow-600",a="fa-eye"):e.includes("è—")||e.includes("è¦åŠƒä¸­")?(t="text-blue-500",a="fa-map"):e.includes("ç¶ ")||e.includes("å·²å®Œæˆ")&&(t="text-green-600",a="fa-check-circle"),`<div class="mt-2 pl-8"><strong class="${t} flex items-center text-sm"><i class="fas ${a} w-5 text-center mr-2"></i>${sanitizeHTML(e)}</strong></div>`}).join("")}`,d=a.length>0?a.map(e=>{let t="text-gray-800",a="fa-lightbulb";return e.title.includes("é€¾æœŸ")?(t="text-red-800",a="fa-fire-alt"):e.title.includes("è½å¾Œ")||e.title.includes("åœæ»¯")?(t="text-orange-600",a="fa-ghost"):e.title.includes("è³‡æº")||e.title.includes("ç“¶é ¸")&&(t="text-purple-600",a="fa-users"),`<div class="space-y-2"><strong class="font-bold ${t} flex items-center text-sm"><i class="fas ${a} w-5 text-center mr-2"></i>${sanitizeHTML(e.title)}</strong><div class="pl-5">${o(e.points)}</div></div>`}).join('<hr class="my-4">'):'<p class="pl-5 text-gray-500">ç›®å‰ç„¡é‡å¤§é¢¨éšªã€‚</p>',c=s.length>0?s.map(e=>{let t="text-green-800",a="fa-lightbulb";return e.title.includes("å„ªå…ˆ")||e.title.includes("æœƒè­°")?a="fa-star":e.title.includes("è³‡æº")||e.title.includes("æª¢è¨")?a="fa-comments":e.title.includes("æ”¯æŒ")||e.title.includes("é—œæ‡·")?a="fa-hands-helping":e.title.includes("å›å ±")||e.title.includes("è¿½è¹¤")&&(a="fa-sync-alt"),`<div class="space-y-2"><strong class="font-bold ${t} flex items-center text-sm"><i class="fas ${a} w-5 text-center mr-2"></i>${sanitizeHTML(e.title)}</strong><div class="pl-5">${o(e.points)}</div></div>`}).join('<hr class="my-4">'):'<p class="pl-5 text-gray-500">ç›®å‰ç„¡å…·é«”æ±ºç­–å»ºè­°ã€‚</p>';let u='<div class="space-y-6">';return u+=l("1. å°ˆæ¡ˆçµ„åˆå¥åº·åº¦é€Ÿè¦½ (RAG åˆ†æ)","text-blue-700","fa-chart-pie",n),u+=l("2. é¢¨éšªè©•ä¼°èˆ‡é€²åº¦è½å¾Œé è­¦","text-red-700","fa-shield-alt",d),u+=l("3. é«˜éšç¶“ç†äººæ±ºç­–å»ºè­°","text-green-700","fa-user-tie",c),u+="</div>"}function setupModal(e,t,a){const s=document.getElementById(e),i=t?document.getElementById(t):null,r=document.getElementById(a),l=()=>s.classList.remove("hidden"),o=()=>s.classList.add("hidden");i&&i.addEventListener("click",l),r.addEventListener("click",o),s.addEventListener("click",e=>{e.target===s&&o()})}function setupAiModal(){setupModal("aiModal","aiBtn","closeAiModalBtn"),document.getElementById("aiBtn").addEventListener("click",getAiSuggestions)}function setupActivityModal(){setupModal("activityModal",null,"closeActivityModalBtn")}function setupWeeklySummaryModal(){setupModal("weeklySummaryModal",null,"closeWeeklySummaryBtn")}function setupItemListModal(){setupModal("itemListModal",null,"closeItemListModalBtn")}function navigateCalendar(e){calendarDate.setMonth(calendarDate.getMonth()+e),openActivityModal(!1)}function generateCalendarHTML(e,t,a){const s={};a.forEach(a=>{if(!a.startDate)return;const i=new Date(a.startDate),r=a.deadline?new Date(a.deadline):new Date(a.startDate);for(let l=new Date(i);l<=r;l.setDate(l.getDate()+1))if(l.getFullYear()===e&&l.getMonth()===t){const e=l.getDate();s[e]||(s[e]=[]),s[e].push(a)}});const i=["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"],r=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"],l=new Date(e,t,1).getDay(),o=new Date(e,t+1,0).getDate();let n=`<div class="mb-6">\n                <div class="flex justify-between items-center mb-4">\n                    <button onclick="navigateCalendar(-1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">&lt;</button>\n                    <h3 class="text-xl font-bold text-purple-700">${e}å¹´ ${i[t]}</h3>\n                    <button onclick="navigateCalendar(1)" class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">&gt;</button>\n                </div>\n                <div class="grid grid-cols-7 gap-1 text-center text-sm">`;r.forEach(e=>{n+=`<div class="font-semibold text-gray-600">${e}</div>`});for(let d=0;d<l;d++)n+="<div></div>";for(let c=1;c<=o;c++){const e=s[c];e?n+=`<div class="relative group flex items-center justify-center">\n                        <div class="mx-auto flex items-center justify-center w-8 h-8 rounded-full border-2 border-purple-400 text-purple-700 font-semibold cursor-pointer">${c}</div>\n                        <span class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 text-xs bg-red-500 text-white rounded-full">${e.length}</span>\n                        <div class="absolute bottom-full mb-2 w-56 p-2 bg-slate-800 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-20 transform -translate-x-1/2 left-1/2">\n                            <ul class="space-y-1">${e.map(e=>`<li class="truncate">${sanitizeHTML(e.name)}</li>`).join("")}</ul>\n                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-4 border-x-transparent border-t-4 border-t-slate-800"></div>\n                        </div>\n                    </div>`:n+=`<div class="flex items-center justify-center w-8 h-8">${c}</div>`}return n+="</div></div>"}function setupScrollToTop(){const e=document.getElementById("scrollToTopBtn");window.onscroll=()=>{document.body.scrollTop>20||document.documentElement.scrollTop>20?e.classList.remove("hidden"):e.classList.add("hidden")},e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})}function viewMemberHistory(e,t){t.stopPropagation(),"ç›§è‹±äº‘"===e?window.open("https://qpig0218.github.io/Ying-Yun/","_blank"):showItemsInModal("custom",e)}function generateDashboardReportHTML(){const e=new Date,t=e.toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}),a=e.getMonth()+1,s=e.getFullYear(),i=allActivities.filter(t=>{const i=new Date(t.startDate);return i.getFullYear()===s&&(i.getMonth()+1)===a}),r=i.filter(e=>"completed"===e.status&&"project"===e.type).length,l=i.filter(e=>"completed"===e.status&&"task"===e.type).length,o=allActivities.filter(e=>"active"===e.status&&"project"===e.type).length,n=allActivities.filter(e=>"active"===e.status&&"task"===e.type).length,d=allActivities.filter(e=>"overdue"===e.status),c=allActivities.filter(t=>"completed"===t.status&&new Date(t.deadline)<=e&&"project"===t.type).sort((e,t)=>new Date(t.deadline)-new Date(e.deadline)),u=c.length>0?c[0]:null,p=i.filter(e=>"completed"===e.status&&"task"===e.type).map(e=>e.name).slice(0,2),g=new Date(e);g.setDate(e.getDate()+7);const m=allActivities.filter(t=>{const a=new Date(t.startDate);return"completed"!==t.status&&a>e&&a<=g}).map(e=>`[${formatDate(e.startDate)}]: ${e.name}`);let h=`<div class="p-2 space-y-4 text-gray-800">`;return h+=`<p>æ‚¨å¥½ï¼é€™æ˜¯æˆªè‡³ <strong>${t}</strong> çš„æœ¬æœˆé‡é»å½™å ±ã€‚</p>`,h+=`<div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">\n                <h3 class="font-bold text-yellow-800">â­ æœ¬æœˆäº®é» (Highlights)</h3>\n                <ul class="list-none text-sm text-yellow-700 mt-2 space-y-1">`,h+=`<li><span class="font-semibold">ğŸ‰ å°ˆæ¡ˆé”æ¨™ï¼š</span> æœ¬æœˆå…±å®Œæˆ <strong>${r}</strong> é …å°ˆæ¡ˆã€<strong>${l}</strong> é …ä»»å‹™ï¼</li>`,u?h+=`<li><span class="font-semibold">ğŸš€ æŒ‡æ¨™å°ˆæ¡ˆä¸Šç·šï¼š</span> ã€Œ${sanitizeHTML(u.name)}ã€å·²æ–¼ ${formatDate(u.deadline)} é †åˆ©å®Œæˆã€‚</li>`:h+='<li><span class="font-semibold">ğŸš€ æŒ‡æ¨™å°ˆæ¡ˆä¸Šç·šï¼š</span> æœ¬æœˆå°šç„¡æŒ‡æ¨™å°ˆæ¡ˆå®Œæˆã€‚</li>',h+="</ul></div>",h+=`<div class="p-3 bg-blue-50 rounded-lg border border-blue-200">\n                <h3 class="font-bold text-blue-800">âš™ï¸ å°ˆæ¡ˆé€²åº¦ (Project Progress)</h3>\n                <ul class="list-none text-sm text-blue-700 mt-2 space-y-1">\n                    <li><strong>é€²è¡Œä¸­å°ˆæ¡ˆï¼š</strong> ${o} é …</li>\n                    <li><strong>é€²è¡Œä¸­ä»»å‹™ï¼š</strong> ${n} é …</li>\n                    <li><strong>æœ¬æœˆå®Œæˆé‡Œç¨‹ç¢‘ï¼š</strong> ${p.length>0?sanitizeHTML(p.join(", ")):"ç„¡"}</li>\n                </ul></div>`,d.length>0&&(h+=`<div class="p-3 bg-red-50 rounded-lg border border-red-200">\n                    <h3 class="font-bold text-red-800">âš ï¸ é¢¨éšªæç¤º</h3>\n                    <p class="text-sm text-red-700 mt-1">ã€Œ${sanitizeHTML(d[0].name)}ã€ç›®å‰è™•æ–¼é€¾æœŸç‹€æ…‹ï¼Œéœ€è² è²¬äºº <strong>${sanitizeHTML(d[0].assignees.join(", "))}</strong> é‡é»é—œæ³¨ã€‚</p>\n                    </div>`),h+=`<div class="p-3 bg-green-50 rounded-lg border border-green-200">\n                <h3 class="font-bold text-green-800">ğŸ—“ï¸ ä¸‹é€±é‡é»é å‘Š (Coming Up)</h3>`,m.length>0?h+=`<ul class="list-none text-sm text-green-700 mt-2 space-y-1">\n                    ${m.map(e=>`<li>${sanitizeHTML(e)}</li>`).join("")}\n                    </ul>`:h+='<p class="text-sm text-green-700 mt-1">ä¸‹é€±å°šç„¡æ’å®šé‡é»äº‹é …ã€‚</p>',h+="</div>",h+='<p class="text-xs text-gray-500 text-center pt-2">å¸Œæœ›é€™ä»½å½™å ±å°æ‚¨æœ‰å¹«åŠ©ï¼</p>',h+="</div>"}function setupChatBot(){const e=document.getElementById("openChatBot"),t=document.getElementById("closeChatBot"),a=document.getElementById("chatBotContainer"),s=document.getElementById("chatBotMessages");e.addEventListener("click",()=>{a.classList.remove("hidden"),s.innerHTML='<div class="p-4"><i class="fas fa-spinner fa-spin text-indigo-500"></i> æ­£åœ¨ç”¢ç”Ÿå ±å‘Š...</div>',setTimeout(()=>{s.innerHTML=generateDashboardReportHTML()},100)}),t.addEventListener("click",()=>{a.classList.add("hidden")})}document.addEventListener("DOMContentLoaded",async function(){const e=document.getElementById("loadingOverlay"),t=document.getElementById("errorDisplay"),a=new URLSearchParams(window.location.search),s=a.get("status");s&&(currentStatusFilter=s),setupLoginModal(),setupChangePasswordModal(),setupAiModal(),setupActivityModal(),setupWeeklySummaryModal(),setupScrollToTop(),setupItemListModal(),renderMonthFilter(),setupChatBot(),e.classList.remove("hidden");try{if(await fetchStaffData(),await fetchAllItems(),renderUnitTabs(),renderYearFilter(),renderDashboard(),s){const e=document.querySelector(`.filter-btn[onclick*="${s}"]`);e&&filterItemsByStatus(s,{target:e})}document.getElementById("openChatBot").classList.remove("hidden")}catch(a){t.querySelector("#errorMessage").textContent=`ç„¡æ³•å¾ä¼ºæœå™¨ç²å–å°ˆæ¡ˆæ•¸æ“šã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚(${a.message})`,t.classList.remove("hidden")}finally{e.classList.add("hidden")}});</script></body></html>
