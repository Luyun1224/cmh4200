<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>個人歷程後台管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .toast { transition: transform .5s, opacity .5s; transform: translateY(100%); opacity: 0; }
    .toast.show { transform: translateY(0); opacity: 1; }
    input[type="date"]:invalid::-webkit-calendar-picker-indicator { opacity: .6; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- === 內容省略：你的原版 HTML 結構完全保留 === -->

  <!-- ======== 省略的區塊以 … 表示，確保結構未動 ======== -->
  … <!--（表單、Modal、Toast DOM 結構與你提供的一致）-->

  <script>
    /* ========= 全域變數 ========= */
    let currentModalType = '';
    let editingIndex     = null;
    let allProfiles      = {};
    let currentStaffName = '';
    let profileData      = {};

    /* <<< 換成你重新部署後的 URL >>> */
    const GOOGLE_SHEET_API_URL =
      'https://script.google.com/macros/s/AKfycbzhYxSKmbpi0_WREpCwcmfMAKfg1KlRDwjg7OWHoNcjXettT4REDRe5FrrumwGm1BkF/exec';

    /* ========= 核心功能 ========= */
    async function fetchAllData () {
      showToast('正在從雲端讀取資料...', 'success');
      try {
        const res = await fetch(GOOGLE_SHEET_API_URL);
        if (!res.ok) throw new Error(`無法連線：${res.statusText}`);
        allProfiles = await res.json();
        showToast('雲端資料讀取完畢！', 'success');
      } catch (err) {
        console.error(err);
        showToast(`讀取失敗：${err.message}`, 'error');
        allProfiles = {};
      }
    }

    async function saveProfile () {
      if (!currentStaffName) { showToast('請先選擇一位人員！','error'); return; }
      const btn = document.getElementById('save-profile-btn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>儲存中...';

      profileData['姓名']     = document.getElementById('profile-name').value;
      profileData['職稱']     = document.getElementById('profile-title').value;
      profileData['入職日期'] = document.getElementById('onboard-date').value;
      allProfiles[currentStaffName] = profileData;

      try {
        const res = await fetch(GOOGLE_SHEET_API_URL, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify(allProfiles)
        });
        if (!res.ok) throw new Error(`伺服器錯誤：${res.statusText}`);
        const result = await res.json();
        if (result.status === 'success') {
          showToast('成功儲存到雲端！', 'success');
        } else {
          throw new Error(result.message || 'Apps Script 執行失敗');
        }
      } catch (err) {
        console.error(err);
        showToast(`儲存失敗：${err.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>儲存個人資料至雲端';
      }
    }

    /* ========= 資料與畫面管理 ========= */
    function getCategoryInfo (type) {
      return {
        '業務職掌': { listName: '業務職掌', listId: 'duties-list' },
        '工作經歷': { listName: '工作經歷', listId: 'experience-list' },
        '專案成果': { listName: '專案成果', listId: 'projects-list' },
        '榮譽事蹟': { listName: '榮譽事蹟', listId: 'honors-list' },
        '教育訓練': { listName: '教育訓練', listId: 'training-list' }
      }[type];
    }

    function loadProfile (name) {
      if (!name) return;
      currentStaffName = name;
      profileData = allProfiles[name] || {
        '姓名'      : name,
        '職稱'      : '',
        '大頭照'    : '',
        '入職日期'  : '',
        '業務職掌'  : [],
        '工作經歷'  : [],
        '專案成果'  : [],
        '榮譽事蹟'  : [],
        '教育訓練'  : []
      };
      document.getElementById('profile-name' ).value = profileData['姓名'];
      document.getElementById('profile-title').value = profileData['職稱'];
      document.getElementById('onboard-date' ).value = profileData['入職日期'];
      document.getElementById('profilePreview').src = profileData['大頭照'] ||
        'https://placehold.co/96x96/E2E8F0/A0AEC0?text=預覽';
      renderAllLists();
    }

    /* === 修正版本：直接列舉五種類別 === */
    function renderAllLists () {
      ['業務職掌','工作經歷','專案成果','榮譽事蹟','教育訓練']
        .forEach(type => renderList(type));
    }

    /* === 之後的 renderList、Modal、Toast… 內容與你原始碼相同 === */
    … /* 省略：其餘 JS 保持不變 */

    /* ========= 事件綁定 ========= */
    document.addEventListener('DOMContentLoaded', async () => {
      await fetchAllData();
      document.getElementById('staff-select').addEventListener('change', e => loadProfile(e.target.value));
      document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
      document.getElementById('upload-photo-btn').addEventListener('click', () => document.getElementById('profilePhoto').click());
      document.getElementById('profilePhoto').addEventListener('change', handlePhotoUpload);
      … /* 其他事件監聽與原碼一致 */
    });
  </script>
</body>
</html>
