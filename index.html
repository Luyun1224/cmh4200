<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教學部專案儀表板 - 登入</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .backdrop-blur-lg {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Auth Container -->
    <div class="w-full max-w-md mx-auto p-8 bg-white/90 backdrop-blur-lg rounded-2xl shadow-2xl border border-gray-200">

        <!-- Login View (Default) -->
        <div id="loginView">
            <h2 class="text-center text-3xl font-bold text-gray-800 mb-8">教學部專案儀表板 - 登入</h2>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">人事號</label>
                    <input type="text" id="username" name="username" required placeholder="請輸入您的人事號" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required placeholder="請輸入您的密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 px-4 text-gray-500">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div id="login-message" class="text-center font-medium h-5"></div>
                <div class="flex items-center gap-4 pt-2">
                     <a href="project.html" class="w-full text-center px-4 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">關閉</a>
                    <button type="submit" id="loginSubmitBtn" class="w-full flex justify-center items-center px-4 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-transform hover:scale-105 shadow-lg">
                        <span class="btn-text">登入</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden btn-spinner"></i>
                    </button>
                </div>
            </form>
            <div class="text-center mt-6">
                <a href="#" id="showChangePasswordViewBtn" class="text-sm text-blue-600 hover:underline">更換密碼</a>
            </div>
        </div>

        <!-- Change Password View (Hidden by default) -->
        <div id="changePasswordView" class="hidden">
            <h2 class="text-center text-3xl font-bold text-gray-800 mb-8">更換密碼</h2>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="cp-employeeId" class="block text-sm font-medium text-gray-700 mb-1">人事號</label>
                    <input type="text" id="cp-employeeId" required placeholder="請輸入您的人事號" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="cp-oldPassword" class="block text-sm font-medium text-gray-700 mb-1">舊密碼</label>
                    <input type="password" id="cp-oldPassword" required placeholder="請輸入您的舊密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="cp-newPassword" class="block text-sm font-medium text-gray-700 mb-1">新密碼</label>
                    <input type="password" id="cp-newPassword" required placeholder="請設定您的新密碼" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="change-password-message" class="text-center font-medium h-5"></div>
                <div class="pt-2">
                    <button type="submit" id="changePasswordSubmitBtn" class="w-full flex justify-center items-center px-4 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-transform hover:scale-105 shadow-lg">
                        <span class="btn-text">確認更換</span>
                        <i class="fas fa-spinner fa-spin ml-2 hidden btn-spinner"></i>
                    </button>
                </div>
            </form>
            <div class="text-center mt-6">
                <a href="#" id="showLoginViewBtn" class="text-sm text-blue-600 hover:underline">返回登入</a>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvl5lYY1LssljDNJJyGuAGsLd3D0sbGSs4QTZxgz2PAZJ38EpsHzEk740LGiQ5AMok/exec";
        const DASHBOARD_URL = 'project.html';

        if (sessionStorage.getItem('dashboardUser')) {
            window.location.href = DASHBOARD_URL;
        }

        const loginView = document.getElementById('loginView');
        const changePasswordView = document.getElementById('changePasswordView');
        const showChangePasswordViewBtn = document.getElementById('showChangePasswordViewBtn');
        const showLoginViewBtn = document.getElementById('showLoginViewBtn');
        const togglePasswordBtn = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        showChangePasswordViewBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            changePasswordView.classList.remove('hidden');
        });

        showLoginViewBtn.addEventListener('click', (e) => {
            e.preventDefault();
            changePasswordView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        togglePasswordBtn.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            togglePasswordBtn.querySelector('i').classList.toggle('fa-eye');
            togglePasswordBtn.querySelector('i').classList.toggle('fa-eye-slash');
        });
        
        const loginForm = document.getElementById('loginForm');
        const loginMessage = document.getElementById('login-message');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const username = event.target.username.value;
            const password = event.target.password.value;
            loginSubmitBtn.disabled = true;
            loginSubmitBtn.querySelector('.btn-text').textContent = '驗證中...';
            loginSubmitBtn.querySelector('.btn-spinner').classList.remove('hidden');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors',
                    body: JSON.stringify({ action: 'login', username, password }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                if (!response.ok) throw new Error(`網路回應錯誤: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    const userData = result.data;
                    if (!userData.role) throw new Error('無法獲取您的角色資訊，請聯繫管理員。');
                    sessionStorage.setItem('dashboardUser', JSON.stringify(userData));
                    loginMessage.textContent = '登入成功！即將跳轉...';
                    loginMessage.className = 'text-center font-medium text-green-600';
                    setTimeout(() => { window.location.href = DASHBOARD_URL; }, 1000);
                } else {
                    throw new Error(result.message || '帳號或密碼錯誤。');
                }
            } catch (error) {
                loginMessage.textContent = error.message;
                loginMessage.className = 'text-center font-medium text-red-500';
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.querySelector('.btn-text').textContent = '登入';
                loginSubmitBtn.querySelector('.btn-spinner').classList.add('hidden');
            }
        });

        const changePasswordForm = document.getElementById('changePasswordForm');
        const cpMessage = document.getElementById('change-password-message');
        const cpSubmitBtn = document.getElementById('changePasswordSubmitBtn');
        changePasswordForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const employeeId = event.target['cp-employeeId'].value;
            const oldPassword = event.target['cp-oldPassword'].value;
            const newPassword = event.target['cp-newPassword'].value;
            cpSubmitBtn.disabled = true;
            cpSubmitBtn.querySelector('.btn-text').textContent = '處理中...';
            cpSubmitBtn.querySelector('.btn-spinner').classList.remove('hidden');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors',
                    body: JSON.stringify({ action: 'updatePassword', employeeId, oldPassword, newPassword }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                if (!response.ok) throw new Error('網路回應錯誤');
                const result = await response.json();
                if (result.status === 'success') {
                    cpMessage.textContent = '密碼更新成功！請返回登入。';
                    cpMessage.className = 'text-center font-medium text-green-600';
                    changePasswordForm.reset();
                } else {
                    throw new Error(result.message || '更新失敗');
                }
            } catch (error) {
                cpMessage.textContent = error.message;
                cpMessage.className = 'text-center font-medium text-red-500';
            } finally {
                cpSubmitBtn.disabled = false;
                cpSubmitBtn.querySelector('.btn-text').textContent = '確認更換';
                cpSubmitBtn.querySelector('.btn-spinner').classList.add('hidden');
            }
        });
    </script>
</body>
</html>

